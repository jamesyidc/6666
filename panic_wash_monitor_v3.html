<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ææ…Œæ¸…æ´—æŒ‡æ ‡ç›‘æ§ - å®æ—¶æ•°æ®</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #4a9eff;
            margin-bottom: 10px;
            font-size: 32px;
            text-shadow: 0 0 10px rgba(74, 158, 255, 0.5);
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .nav-link {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.2) 0%, rgba(102, 126, 234, 0.2) 100%);
            border: 1px solid rgba(74, 158, 255, 0.5);
            border-radius: 8px;
            color: #4a9eff;
            text-decoration: none;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.3) 0%, rgba(102, 126, 234, 0.3) 100%);
            border-color: #4a9eff;
            transform: translateY(-2px);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(74, 158, 255, 0.2);
            border-color: rgba(74, 158, 255, 0.5);
        }

        .stat-label {
            font-size: 14px;
            color: #888;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #4a9eff;
        }

        .stat-value.green {
            color: #00ff88;
        }

        .stat-value.red {
            color: #ff4444;
        }

        .stat-value.yellow {
            color: #ffaa00;
        }

        .refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 20px;
            background: linear-gradient(135deg, #00c853 0%, #00e676 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #00e676 0%, #00ff88 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 200, 83, 0.4);
        }

        .refresh-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            height: 500px;
        }

        .data-table-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.3) 0%, rgba(102, 126, 234, 0.3) 100%);
            color: #4a9eff;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid rgba(74, 158, 255, 0.5);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        tr:hover {
            background: rgba(74, 158, 255, 0.1);
        }

        .indicator-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        .indicator-badge.green {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }

        .indicator-badge.yellow {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
            border: 1px solid #ffaa00;
        }

        .indicator-badge.red {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border: 1px solid #ff4444;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 18px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ff4444;
            font-size: 18px;
        }

        .countdown {
            display: inline-block;
            color: #888;
            font-size: 13px;
            margin-left: 10px;
        }

        .filter-container {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-item label {
            color: #888;
            font-size: 14px;
        }

        .filter-item input,
        .filter-item select {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #eee;
            font-size: 14px;
        }

        .filter-item input:focus,
        .filter-item select:focus {
            outline: none;
            border-color: #4a9eff;
            background: rgba(255, 255, 255, 0.15);
        }

        .time-display {
            color: #4a9eff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="nav-link">ğŸ  è¿”å›é¦–é¡µ</a>
        
        <h1>ğŸ“Š ææ…Œæ¸…æ´—æŒ‡æ ‡ç›‘æ§</h1>
        <div class="subtitle">
            å®æ—¶ç›‘æ§ Â· 3åˆ†é’Ÿè‡ªåŠ¨æ›´æ–° Â· æ•°æ®æ¥æº: Google Drive
            <span class="countdown" id="countdown"></span>
        </div>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">ğŸ“Š ææ…Œæ¸…æ´—æŒ‡æ ‡</div>
                <div class="stat-value" id="panicIndicator">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ’° å…¨ç½‘æŒä»“é‡</div>
                <div class="stat-value green" id="totalPosition">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ“ˆ è¶‹åŠ¿è¯„çº§</div>
                <div class="stat-value" id="trendRating">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ¯ å¸‚åœºåŒºé—´</div>
                <div class="stat-value" id="marketZone">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ‘¥ 24hçˆ†ä»“äººæ•°</div>
                <div class="stat-value red" id="liquidationPeople">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ’¸ 24hçˆ†ä»“é‡‘é¢</div>
                <div class="stat-value red" id="liquidationAmount">--</div>
            </div>
        </div>

        <button class="refresh-btn" onclick="forceRefresh()">
            <span id="refreshIcon">ğŸ”„</span> ç«‹å³åˆ·æ–°
        </button>
        <span class="time-display" id="updateTime">æ›´æ–°æ—¶é—´: --</span>

        <!-- æ›²çº¿å›¾ -->
        <div class="chart-container">
            <canvas id="panicChart"></canvas>
        </div>

        <!-- æ•°æ®ç­›é€‰ -->
        <div class="filter-container">
            <div class="filter-item">
                <label>æ˜¾ç¤ºæœ€è¿‘:</label>
                <select id="dataLimit" onchange="updateTable()">
                    <option value="50">50æ¡</option>
                    <option value="100">100æ¡</option>
                    <option value="200">200æ¡</option>
                    <option value="500">500æ¡</option>
                </select>
            </div>
            <div class="filter-item">
                <label>å¼€å§‹æ—¥æœŸ:</label>
                <input type="date" id="startDate" onchange="updateTable()">
            </div>
            <div class="filter-item">
                <label>ç»“æŸæ—¥æœŸ:</label>
                <input type="date" id="endDate" onchange="updateTable()">
            </div>
        </div>

        <!-- æ•°æ®åˆ—è¡¨ -->
        <div class="data-table-container">
            <h3 style="color: #4a9eff; margin-bottom: 15px;">ğŸ“‹ å†å²æ•°æ®è®°å½•</h3>
            <div id="loadingMsg" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
            <div id="errorMsg" class="error" style="display:none;"></div>
            <table id="dataTable" style="display:none;">
                <thead>
                    <tr>
                        <th>åºå·</th>
                        <th>è®°å½•æ—¶é—´</th>
                        <th>ææ…Œæ¸…æ´—æŒ‡æ ‡</th>
                        <th>å…¨ç½‘æŒä»“é‡(äº¿)</th>
                        <th>è¶‹åŠ¿è¯„çº§</th>
                        <th>å¸‚åœºåŒºé—´</th>
                        <th>24hçˆ†ä»“äººæ•°</th>
                        <th>24hçˆ†ä»“é‡‘é¢(äº¿)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let panicChart = null;
        let allData = [];
        let refreshTimer = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('panicChart').getContext('2d');
            
            panicChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'ææ…Œæ¸…æ´—æŒ‡æ ‡',
                            data: [],
                            borderColor: '#ff4444',
                            backgroundColor: 'rgba(255, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'å…¨ç½‘æŒä»“é‡(äº¿)',
                            data: [],
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0, 255, 136, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#eee',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'ææ…Œæ¸…æ´—æŒ‡æ ‡ & å…¨ç½‘æŒä»“é‡ åŒè½´æ›²çº¿å›¾',
                            color: '#4a9eff',
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#4a9eff',
                            bodyColor: '#eee',
                            borderColor: '#4a9eff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#888',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ææ…Œæ¸…æ´—æŒ‡æ ‡',
                                color: '#ff4444',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#ff4444'
                            },
                            grid: {
                                color: 'rgba(255, 68, 68, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'å…¨ç½‘æŒä»“é‡(äº¿)',
                                color: '#00ff88',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#00ff88'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const response = await fetch('/api/panic-wash');
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'æ•°æ®åŠ è½½å¤±è´¥');
                }

                const data = result.data;

                // æ›´æ–°ç»Ÿè®¡é¢æ¿
                const indicatorParts = data.panic_indicator.split('-');
                const indicatorValue = indicatorParts[0];
                const indicatorColor = indicatorParts[1] || '';

                document.getElementById('panicIndicator').textContent = indicatorValue;
                document.getElementById('panicIndicator').className = 'stat-value ' + 
                    (indicatorColor === 'ç»¿' ? 'green' : indicatorColor === 'é»„' ? 'yellow' : 'red');

                document.getElementById('totalPosition').textContent = data.total_position + ' äº¿';
                document.getElementById('trendRating').textContent = data.trend_rating;
                document.getElementById('marketZone').textContent = data.market_zone;
                document.getElementById('liquidationPeople').textContent = parseInt(data.liquidation_24h_people).toLocaleString();
                document.getElementById('liquidationAmount').textContent = data.liquidation_24h_amount + ' äº¿';
                document.getElementById('updateTime').textContent = 'æ›´æ–°æ—¶é—´: ' + data.update_time;

                // åŠ è½½å†å²æ•°æ®
                await loadHistoryData();

                // å¯åŠ¨å€’è®¡æ—¶
                startCountdown(180); // 3åˆ†é’Ÿ

            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                document.getElementById('errorMsg').textContent = 'æ•°æ®åŠ è½½å¤±è´¥: ' + error.message;
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        // åŠ è½½å†å²æ•°æ®
        async function loadHistoryData() {
            try {
                const response = await fetch('/api/panic-wash/history');
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'å†å²æ•°æ®åŠ è½½å¤±è´¥');
                }

                allData = result.data;
                updateChart();
                updateTable();

                document.getElementById('dataTable').style.display = 'table';
                document.getElementById('loadingMsg').style.display = 'none';

            } catch (error) {
                console.error('å†å²æ•°æ®åŠ è½½å¤±è´¥:', error);
                document.getElementById('errorMsg').textContent = 'å†å²æ•°æ®åŠ è½½å¤±è´¥: ' + error.message;
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        // æ›´æ–°å›¾è¡¨
        function updateChart() {
            if (!panicChart || allData.length === 0) return;

            // å–æœ€è¿‘50ä¸ªæ•°æ®ç‚¹
            const chartData = allData.slice(0, 50).reverse();

            const labels = chartData.map(d => {
                const time = d.time || d.record_time;
                return time.substring(5, 16); // MM-DD HH:MM
            });

            const panicValues = chartData.map(d => {
                const indicator = d.panic_indicator || d.panic_indicator_value;
                return parseFloat(indicator);
            });

            const positionValues = chartData.map(d => {
                return parseFloat(d.total_position);
            });

            panicChart.data.labels = labels;
            panicChart.data.datasets[0].data = panicValues;
            panicChart.data.datasets[1].data = positionValues;
            panicChart.update();
        }

        // æ›´æ–°è¡¨æ ¼
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const limit = parseInt(document.getElementById('dataLimit').value) || 50;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            let filteredData = [...allData];

            // æ—¥æœŸç­›é€‰
            if (startDate) {
                filteredData = filteredData.filter(d => (d.record_time || d.time) >= startDate);
            }
            if (endDate) {
                filteredData = filteredData.filter(d => (d.record_time || d.time) <= endDate + ' 23:59:59');
            }

            // é™åˆ¶æ•°é‡
            filteredData = filteredData.slice(0, limit);

            filteredData.forEach((item, index) => {
                const row = document.createElement('tr');
                
                const indicatorParts = (item.panic_indicator || '').split('-');
                const indicatorValue = indicatorParts[0];
                const indicatorColor = indicatorParts[1] || '';
                
                const badgeClass = indicatorColor === 'ç»¿' ? 'green' : 
                                  indicatorColor === 'é»„' ? 'yellow' : 'red';

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.record_time || item.time}</td>
                    <td><span class="indicator-badge ${badgeClass}">${indicatorValue}-${indicatorColor}</span></td>
                    <td>${item.total_position}</td>
                    <td>${item.trend_rating || '-'}</td>
                    <td>${item.market_zone || '-'}</td>
                    <td>${item.liquidation_24h_people ? parseInt(item.liquidation_24h_people).toLocaleString() : '-'}</td>
                    <td>${item.liquidation_24h_amount || '-'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // å¼ºåˆ¶åˆ·æ–°
        async function forceRefresh() {
            const btn = document.querySelector('.refresh-btn');
            const icon = document.getElementById('refreshIcon');
            
            try {
                btn.disabled = true;
                icon.textContent = 'â³';
                
                await loadData();
                
                icon.textContent = 'âœ…';
                setTimeout(() => {
                    icon.textContent = 'ğŸ”„';
                }, 2000);
                
            } catch (error) {
                icon.textContent = 'âŒ';
                setTimeout(() => {
                    icon.textContent = 'ğŸ”„';
                }, 2000);
            } finally {
                btn.disabled = false;
            }
        }

        // å€’è®¡æ—¶
        function startCountdown(seconds) {
            if (refreshTimer) clearInterval(refreshTimer);
            
            let remaining = seconds;
            
            refreshTimer = setInterval(() => {
                remaining--;
                
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                document.getElementById('countdown').textContent = 
                    `ä¸‹æ¬¡æ›´æ–°: ${minutes}:${secs.toString().padStart(2, '0')}`;
                
                if (remaining <= 0) {
                    clearInterval(refreshTimer);
                    loadData();
                }
            }, 1000);
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            initChart();
            loadData();
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('endDate').value = today;
        };
    </script>
</body>
</html>
