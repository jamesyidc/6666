<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>åŠ å¯†è´§å¸é¦–é¡µæ•°æ®ç›‘æ§ V2.2 - å†å²æ•°æ®æ›²çº¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #4a9eff;
            margin-bottom: 20px;
        }

        .nav-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .nav-link {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.2) 0%, rgba(102, 126, 234, 0.2) 100%);
            border: 1px solid rgba(74, 158, 255, 0.5);
            border-radius: 8px;
            color: #4a9eff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.3) 0%, rgba(102, 126, 234, 0.3) 100%);
            border-color: #4a9eff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
        }

        .stats-bar {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-label {
            color: #888;
            font-size: 14px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
        }

        .stat-value.up {
            color: #00ff88;
        }

        .stat-value.down {
            color: #ff4444;
        }

        .update-time {
            color: #4a9eff;
            font-size: 14px;
        }

        /* æ˜Ÿçº§æé†’é¢æ¿ */
        .alert-panel {
            background: linear-gradient(135deg, #16213e 0%, #1a2332 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #2a3f5f;
        }

        .alert-title {
            font-size: 20px;
            font-weight: bold;
            color: #4a9eff;
            margin-bottom: 15px;
            text-align: center;
        }

        .alert-grid {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .alert-box {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(74, 158, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .alert-box:hover {
            transform: translateY(-3px);
            border-color: #4a9eff;
            box-shadow: 0 5px 20px rgba(74, 158, 255, 0.3);
        }

        .alert-box.warning {
            border-color: rgba(255, 204, 0, 0.5);
        }

        .alert-box.danger {
            border-color: rgba(255, 68, 68, 0.5);
        }

        .alert-box-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 8px;
        }

        .alert-box-value {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 10px;
        }

        .alert-box-stars {
            font-size: 28px;
            margin-bottom: 5px;
            min-height: 35px;
        }

        .star-filled {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .star-empty {
            color: #4a9eff;
            text-shadow: 0 0 10px rgba(74, 158, 255, 0.5);
        }

        .alert-box-desc {
            font-size: 12px;
            color: #888;
        }

        .coin-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 11px;
            text-align: left;
            padding: 8px;
            margin-top: 8px;
            display: block;
            width: 100%;
        }

        .coin-item {
            padding: 3px 5px;
            margin: 2px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .coin-name {
            font-weight: bold;
            color: #4a9eff;
            flex: 1;
        }

        .coin-rush {
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 2px;
            margin-left: 5px;
        }

        .coin-rush.up {
            background: rgba(255, 68, 68, 0.3);
            color: #ff4444;
        }

        .coin-rush.down {
            background: rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }

        .coin-tag {
            display: inline-block;
            padding: 4px 10px;
            margin: 3px 2px;
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.3) 0%, rgba(102, 126, 234, 0.3) 100%);
            border: 1px solid rgba(74, 158, 255, 0.6);
            border-radius: 5px;
            color: #4a9eff;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .coin-tag:hover {
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.3) 0%, rgba(102, 126, 234, 0.3) 100%);
            border-color: #4a9eff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(74, 158, 255, 0.3);
        }

        .coin-list::-webkit-scrollbar {
            width: 4px;
        }

        .coin-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .coin-list::-webkit-scrollbar-thumb {
            background: rgba(74, 158, 255, 0.5);
            border-radius: 2px;
        }

        .alert-summary {
            display: flex;
            justify-content: center;
            gap: 40px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 14px;
            color: #888;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 36px;
            font-weight: bold;
        }

        .summary-value.filled {
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .summary-value.empty {
            color: #4a9eff;
            text-shadow: 0 0 20px rgba(74, 158, 255, 0.5);
        }

        @media (max-width: 1600px) {
            .alert-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        @media (max-width: 1400px) {
            .alert-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .alert-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .alert-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .alert-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            height: 400px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #16213e;
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: #0f1419;
        }

        th {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            color: #4a9eff;
            border-bottom: 2px solid #2a2a3e;
        }

        td {
            padding: 10px 8px;
            text-align: center;
            font-size: 13px;
            border-bottom: 1px solid #2a2a3e;
        }

        tr:hover {
            background: #1e2838;
        }

        .symbol {
            font-weight: bold;
            color: #fff;
            font-size: 15px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 6px 10px;
            border-radius: 5px;
        }

        .positive {
            color: #00ff88;
        }

        .negative {
            color: #ff4444;
        }

        .neutral {
            color: #888;
        }

        .rush-up {
            background: linear-gradient(135deg, #ff4444 0%, #ff6666 100%);
            color: #fff;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 700;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        .rush-down {
            background: linear-gradient(135deg, #00ff88 0%, #00ffaa 100%);
            color: #000;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 700;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4a9eff;
        }

        .error {
            background: #ff4444;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .countdown {
            color: #888;
            font-size: 12px;
            margin-left: 10px;
        }

        .refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 15px;
            background: linear-gradient(135deg, #00c853 0%, #00e676 100%);
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 15px;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #00e676 0%, #00ff88 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 200, 83, 0.4);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .refresh-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .refresh-btn.refreshing {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .priority-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 11px;
            text-align: center;
            min-width: 60px;
        }

        .priority-1 { background: #ff0000; color: #fff; }
        .priority-2 { background: #ff6600; color: #fff; }
        .priority-3 { background: #ff9900; color: #fff; }
        .priority-4 { background: #ffcc00; color: #000; }
        .priority-5 { background: #99cc00; color: #000; }
        .priority-6 { background: #666666; color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-links">
            <a href="/" class="nav-link">ğŸ  è¿”å›é¦–é¡µ</a>
        </div>
        
        <h1>ğŸª™ åŠ å¯†è´§å¸é¦–é¡µæ•°æ®ç›‘æ§ <span style="font-size:14px; color:#ffaa00;">[V2.2-å†å²æ•°æ®]</span></h1>
        
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <span class="stat-label">æ€¥æ¶¨ï¼š</span>
                <span class="stat-value up" id="rushUp">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">æ€¥è·Œï¼š</span>
                <span class="stat-value down" id="rushDown">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">çŠ¶æ€ï¼š</span>
                <span class="stat-value" id="status">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">æ¯”å€¼ï¼š</span>
                <span class="stat-value" id="ratio">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ç»¿è‰²æ•°é‡ï¼š</span>
                <span class="stat-value" id="greenCount">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ç™¾åˆ†æ¯”ï¼š</span>
                <span class="stat-value" id="percentage">-</span>
            </div>
            <div class="stat-item">
                <span class="update-time" id="updateTime">æ›´æ–°æ—¶é—´: --</span>
                <span class="countdown" id="countdown"></span>
                <button class="refresh-btn" id="refreshBtn" onclick="forceRefreshData()">
                    <span id="refreshIcon">ğŸ”„</span> ç«‹å³åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- æ˜Ÿçº§æé†’é¢æ¿ -->
        <div class="alert-panel">
            <div class="alert-title" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
                <span>â­ æ˜Ÿçº§æé†’ç³»ç»Ÿ</span>
                <div style="display: flex; gap: 20px; font-size: 18px; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: #ffd700; font-weight: bold;" id="totalFilledStarsTop">0</span>
                        <span style="color: #ffd700; font-size: 24px;">â˜…</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: #4a9eff; font-weight: bold;" id="totalEmptyStarsTop">0</span>
                        <span style="color: #4a9eff; font-size: 24px;">â˜†</span>
                    </div>
                </div>
            </div>
            
            <div class="alert-grid">
                <!-- 1. æ€¥æ¶¨æé†’ -->
                <div class="alert-box" id="alertRushUp">
                    <div class="alert-box-title">æ€¥æ¶¨æé†’</div>
                    <div class="alert-box-value" id="alertRushUpValue">0</div>
                    <div class="alert-box-stars" id="alertRushUpStars">-</div>
                    <div class="alert-box-desc" id="alertRushUpDesc">ç­‰å¾…æ•°æ®</div>
                </div>

                <!-- 2. æ€¥è·Œæé†’ -->
                <div class="alert-box" id="alertRushDown">
                    <div class="alert-box-title">æ€¥è·Œæé†’</div>
                    <div class="alert-box-value" id="alertRushDownValue">0</div>
                    <div class="alert-box-stars" id="alertRushDownStars">-</div>
                    <div class="alert-box-desc" id="alertRushDownDesc">ç­‰å¾…æ•°æ®</div>
                </div>

                <!-- 3. å·®å€¼æ­£å€¼ -->
                <div class="alert-box" id="alertDiffPositive">
                    <div class="alert-box-title">å·®å€¼æ­£å€¼</div>
                    <div class="alert-box-value" id="alertDiffPositiveValue">0</div>
                    <div class="alert-box-stars" id="alertDiffPositiveStars">-</div>
                    <div class="alert-box-desc" id="alertDiffPositiveDesc">ç­‰å¾…æ•°æ®</div>
                </div>

                <!-- 4. å·®å€¼è´Ÿå€¼ -->
                <div class="alert-box" id="alertDiffNegative">
                    <div class="alert-box-title">å·®å€¼è´Ÿå€¼</div>
                    <div class="alert-box-value" id="alertDiffNegativeValue">0</div>
                    <div class="alert-box-stars" id="alertDiffNegativeStars">-</div>
                    <div class="alert-box-desc" id="alertDiffNegativeDesc">ç­‰å¾…æ•°æ®</div>
                </div>

                <!-- 5. æŒä»“é‡ -->
                <div class="alert-box" id="alertPosition">
                    <div class="alert-box-title">å…¨ç½‘æŒä»“é‡</div>
                    <div class="alert-box-value" id="alertPositionValue">0<span style="font-size:14px;">äº¿</span></div>
                    <div class="alert-box-stars" id="alertPositionStars">-</div>
                    <div class="alert-box-desc" id="alertPositionDesc">ç­‰å¾…æ•°æ®</div>
                </div>

                <!-- 6. åšå¤šä¿¡å· -->
                <div class="alert-box" id="alertLongSignal">
                    <div class="alert-box-title">åšå¤šä¿¡å·</div>
                    <div class="alert-box-value" id="alertLongSignalValue">0</div>
                    <div class="alert-box-stars" id="alertLongSignalStars">-</div>
                    <div class="alert-box-desc" id="alertLongSignalDesc">ç­‰å¾…æ•°æ®</div>
                </div>

                <!-- 7. åšç©ºä¿¡å· -->
                <div class="alert-box" id="alertShortSignal">
                    <div class="alert-box-title">åšç©ºä¿¡å·</div>
                    <div class="alert-box-value" id="alertShortSignalValue">0</div>
                    <div class="alert-box-stars" id="alertShortSignalStars">-</div>
                    <div class="alert-box-desc" id="alertShortSignalDesc">ç­‰å¾…æ•°æ®</div>
                </div>

                <!-- 8. åªæœ‰æ€¥æ¶¨ -->
                <div class="alert-box" id="alertOnlyRushUp">
                    <div class="alert-box-title">åªæœ‰æ€¥æ¶¨</div>
                    <div class="alert-box-value" id="alertOnlyRushUpValue">0</div>
                    <div class="alert-box-stars" id="alertOnlyRushUpStars">-</div>
                    <div class="alert-box-desc" id="alertOnlyRushUpDesc">ç­‰å¾…æ•°æ®</div>
                    <div class="coin-list" id="alertOnlyRushUpList"></div>
                </div>

                <!-- 9. æ€¥æ¶¨>æ€¥è·Œ -->
                <div class="alert-box" id="alertUpGreaterDown">
                    <div class="alert-box-title">æ€¥æ¶¨>æ€¥è·Œ</div>
                    <div class="alert-box-value" id="alertUpGreaterDownValue">0</div>
                    <div class="alert-box-stars" id="alertUpGreaterDownStars">-</div>
                    <div class="alert-box-desc" id="alertUpGreaterDownDesc">ç­‰å¾…æ•°æ®</div>
                    <div class="coin-list" id="alertUpGreaterDownList"></div>
                </div>

                <!-- 10. ä¼˜å…ˆçº§â‰¥4 -->
                <div class="alert-box" id="alertPriority">
                    <div class="alert-box-title">ä¼˜å…ˆçº§â‰¥4</div>
                    <div class="alert-box-value" id="alertPriorityValue">0</div>
                    <div class="alert-box-stars" id="alertPriorityStars">-</div>
                    <div class="alert-box-desc" id="alertPriorityDesc">ç­‰å¾…æ•°æ®</div>
                    <div class="coin-list" id="alertPriorityList"></div>
                </div>

                <!-- 11. åªæœ‰æ€¥è·Œ -->
                <div class="alert-box" id="alertOnlyRushDown">
                    <div class="alert-box-title">åªæœ‰æ€¥è·Œ</div>
                    <div class="alert-box-value" id="alertOnlyRushDownValue">0</div>
                    <div class="alert-box-stars" id="alertOnlyRushDownStars">-</div>
                    <div class="alert-box-desc" id="alertOnlyRushDownDesc">ç­‰å¾…æ•°æ®</div>
                    <div class="coin-list" id="alertOnlyRushDownList"></div>
                </div>
            </div>

            <!-- ç»Ÿè®¡æ±‡æ€» -->
            <div class="alert-summary">
                <div class="summary-item">
                    <div class="summary-label">å®å¿ƒæ˜Ÿæ˜Ÿæ€»æ•°</div>
                    <div class="summary-value filled" id="totalFilledStars">0 â˜…</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ç©ºå¿ƒæ˜Ÿæ˜Ÿæ€»æ•°</div>
                    <div class="summary-value empty" id="totalEmptyStars">0 â˜†</div>
                </div>
            </div>
        </div>

        <!-- æ›²çº¿å›¾ -->
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>

        <div id="loadingMsg" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        <div id="errorMsg" class="error" style="display:none;"></div>

        <table id="dataTable" style="display:none;">
            <thead>
                <tr>
                    <th>ä¼˜å…ˆçº§</th>
                    <th>åºå·</th>
                    <th style="background:#2a5298; font-size:14px; font-weight:700;">ğŸ’° å¸å</th>
                    <th>æ¶¨é€Ÿ</th>
                    <th style="background:#ff4444; font-size:14px; font-weight:700;">ğŸ“ˆ æ€¥æ¶¨</th>
                    <th style="background:#00ff88; color:#000; font-size:14px; font-weight:700;">ğŸ“‰ æ€¥è·Œ</th>
                    <th>æ›´æ–°æ—¶é—´</th>
                    <th>å†å²é«˜ä»·</th>
                    <th>é«˜ä»·æ—¶é—´</th>
                    <th>è·Œå¹…</th>
                    <th>24hæ¶¨å¹…</th>
                    <th>æ’è¡Œ</th>
                    <th>å½“å‰ä»·æ ¼</th>
                    <th>æœ€é«˜ç‚¹æ¯”</th>
                    <th>æœ€ä½ç‚¹æ¯”</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <script>
        let autoRefreshTimer = null;
        let countdownTimer = null;
        let trendChart = null;
        let historyData = [];
        const MAX_HISTORY_POINTS = 50; // æœ€å¤šæ˜¾ç¤º50ä¸ªæ•°æ®ç‚¹

        // ä¼˜å…ˆçº§è®¡ç®—å‡½æ•°
        function parseRatio(ratioStr) {
            if (!ratioStr || ratioStr === '-') return 0;
            try {
                return parseFloat(ratioStr.replace('%', ''));
            } catch {
                return 0;
            }
        }

        function calculatePriority(ratio1Str, ratio2Str) {
            const ratio1 = parseRatio(ratio1Str); // æœ€é«˜ç‚¹æ¯”
            const ratio2 = parseRatio(ratio2Str); // æœ€ä½ç‚¹æ¯”
            
            // æŒ‰ä¼˜å…ˆçº§é¡ºåºåˆ¤æ–­
            if (ratio1 > 90 && ratio2 > 120) return { level: 1, text: 'ç­‰çº§1', stars: 'â­â­â­â­â­' };
            if (ratio1 > 80 && ratio2 > 120) return { level: 2, text: 'ç­‰çº§2', stars: 'â­â­â­â­' };
            if (ratio1 > 90 && ratio2 > 110) return { level: 3, text: 'ç­‰çº§3', stars: 'â­â­â­' };
            if (ratio1 > 70 && ratio2 > 120) return { level: 4, text: 'ç­‰çº§4', stars: 'â­â­' };
            if (ratio1 > 80 && ratio2 > 110) return { level: 5, text: 'ç­‰çº§5', stars: 'â­' };
            return { level: 6, text: 'ç­‰çº§6', stars: 'â€”' };
        }

        // æ›´æ–°æ˜Ÿçº§æé†’é¢æ¿
        function updateAlertPanel(stats, coins) {
            // è·å–æ•°æ®å¹¶è½¬æ¢ä¸ºæ•°å­—
            const rushUp = parseInt(stats.rushUp) || 0;
            const rushDown = parseInt(stats.rushDown) || 0;
            const diff = rushUp - rushDown;

            // ç»Ÿè®¡å¸ç§æ•°æ®å¹¶æ”¶é›†å¸ç§ä¿¡æ¯
            let onlyRushUpCoins = [];    // åªæœ‰æ€¥æ¶¨æ²¡æœ‰æ€¥è·Œ
            let upGreaterDownCoins = []; // æ€¥æ¶¨>æ€¥è·Œ
            let priorityCoins = [];      // ä¼˜å…ˆçº§â‰¥4
            let onlyRushDownCoins = [];  // åªæœ‰æ€¥è·Œ

            coins.forEach(coin => {
                const coinRushUp = parseInt(coin.rushUp) || 0;
                const coinRushDown = parseInt(coin.rushDown) || 0;
                const priority = calculatePriority(coin.ratio1, coin.ratio2);

                // 8. åªæœ‰æ€¥æ¶¨ï¼Œæ²¡æœ‰æ€¥è·Œ
                if (coinRushUp > 0 && coinRushDown === 0) {
                    onlyRushUpCoins.push({
                        symbol: coin.symbol,
                        rushUp: coinRushUp,
                        rushDown: coinRushDown
                    });
                }

                // 9. æ€¥æ¶¨>æ€¥è·Œ
                if (coinRushUp > coinRushDown) {
                    upGreaterDownCoins.push({
                        symbol: coin.symbol,
                        rushUp: coinRushUp,
                        rushDown: coinRushDown
                    });
                }

                // 10. ä¼˜å…ˆçº§â‰¥4 (level 1,2,3,4)
                if (priority.level >= 1 && priority.level <= 4) {
                    priorityCoins.push({
                        symbol: coin.symbol,
                        rushUp: coinRushUp,
                        rushDown: coinRushDown,
                        priority: priority.text
                    });
                }

                // 11. åªæœ‰æ€¥è·Œ
                if (coinRushDown > 0 && coinRushUp === 0) {
                    onlyRushDownCoins.push({
                        symbol: coin.symbol,
                        rushUp: coinRushUp,
                        rushDown: coinRushDown
                    });
                }
            });

            // å¹¶è¡Œè·å–ææ…Œæ¸…æ´—æ•°æ®å’Œä¿¡å·ç»Ÿè®¡æ•°æ®
            Promise.all([
                fetch('/api/panic-wash').then(res => res.json()).catch(() => ({success: false})),
                fetch('/api/signal-stats/latest').then(res => res.json()).catch(() => ({success: false}))
            ]).then(([panicResult, signalResult]) => {
                const position = panicResult.success ? parseFloat(panicResult.data.total_position) : 0;
                const longSignal = signalResult.success ? parseInt(signalResult.data.long_count) || 0 : 0;
                const shortSignal = signalResult.success ? parseInt(signalResult.data.short_count) || 0 : 0;
                
                calculateAndUpdateAlerts(rushUp, rushDown, diff, position, longSignal, shortSignal, 
                    onlyRushUpCoins, upGreaterDownCoins, priorityCoins, onlyRushDownCoins);
            });
        }

        function calculateAndUpdateAlerts(rushUp, rushDown, diff, position, longSignal, shortSignal, 
            onlyRushUpCoins, upGreaterDownCoins, priorityCoins, onlyRushDownCoins) {
            // è·å–æ•°é‡
            const onlyRushUpCount = onlyRushUpCoins.length;
            const upGreaterDownCount = upGreaterDownCoins.length;
            const priorityCount = priorityCoins.length;
            const onlyRushDownCount = onlyRushDownCoins.length;
            let totalFilled = 0;  // å®å¿ƒæ˜Ÿæ˜Ÿæ€»æ•°
            let totalEmpty = 0;   // ç©ºå¿ƒæ˜Ÿæ˜Ÿæ€»æ•°

            // 1. æ€¥æ¶¨æé†’ï¼ˆå®å¿ƒæ˜Ÿï¼‰
            let rushUpStars = 0;
            let rushUpDesc = '';
            if (rushUp >= 100) {
                rushUpStars = 3;
                rushUpDesc = 'è¶…é«˜æ€¥æ¶¨ï¼';
            } else if (rushUp >= 50) {
                rushUpStars = 2;
                rushUpDesc = 'é«˜æ€¥æ¶¨';
            } else if (rushUp >= 10) {
                rushUpStars = 1;
                rushUpDesc = 'æœ‰æ€¥æ¶¨';
            } else {
                rushUpDesc = 'æ­£å¸¸';
            }
            totalFilled += rushUpStars;

            document.getElementById('alertRushUpValue').textContent = rushUp;
            document.getElementById('alertRushUpStars').innerHTML = 
                '<span class="star-filled">' + 'â˜…'.repeat(rushUpStars) + '</span>';
            document.getElementById('alertRushUpDesc').textContent = rushUpDesc;
            document.getElementById('alertRushUp').className = 
                'alert-box' + (rushUpStars >= 2 ? ' danger' : rushUpStars >= 1 ? ' warning' : '');

            // 2. æ€¥è·Œæé†’ï¼ˆç©ºå¿ƒæ˜Ÿï¼‰
            let rushDownStars = 0;
            let rushDownDesc = '';
            if (rushDown >= 100) {
                rushDownStars = 3;
                rushDownDesc = 'è¶…é«˜æ€¥è·Œï¼';
            } else if (rushDown >= 50) {
                rushDownStars = 2;
                rushDownDesc = 'é«˜æ€¥è·Œ';
            } else if (rushDown >= 10) {
                rushDownStars = 1;
                rushDownDesc = 'æœ‰æ€¥è·Œ';
            } else {
                rushDownDesc = 'æ­£å¸¸';
            }
            totalEmpty += rushDownStars;

            document.getElementById('alertRushDownValue').textContent = rushDown;
            document.getElementById('alertRushDownStars').innerHTML = 
                '<span class="star-empty">' + 'â˜†'.repeat(rushDownStars) + '</span>';
            document.getElementById('alertRushDownDesc').textContent = rushDownDesc;
            document.getElementById('alertRushDown').className = 
                'alert-box' + (rushDownStars >= 2 ? ' danger' : rushDownStars >= 1 ? ' warning' : '');

            // 3. å·®å€¼æ­£å€¼ï¼ˆå®å¿ƒæ˜Ÿï¼‰
            let diffPosStars = 0;
            let diffPosDesc = '';
            if (diff >= 50) {
                diffPosStars = 3;
                diffPosDesc = 'æå¼ºå¤šå¤´ï¼';
            } else if (diff >= 20) {
                diffPosStars = 2;
                diffPosDesc = 'å¼ºå¤šå¤´';
            } else if (diff >= 10) {
                diffPosStars = 1;
                diffPosDesc = 'åå¤šå¤´';
            } else if (diff > 0) {
                diffPosDesc = 'å¾®å¤šå¤´';
            } else {
                diffPosDesc = '-';
            }
            if (diff >= 10) {
                totalFilled += diffPosStars;
            }

            document.getElementById('alertDiffPositiveValue').textContent = diff >= 0 ? `+${diff}` : '-';
            if (diff >= 10) {
                document.getElementById('alertDiffPositiveStars').innerHTML = 
                    '<span class="star-filled">' + 'â˜…'.repeat(diffPosStars) + '</span>';
            } else {
                document.getElementById('alertDiffPositiveStars').textContent = '-';
            }
            document.getElementById('alertDiffPositiveDesc').textContent = diffPosDesc;
            document.getElementById('alertDiffPositive').className = 
                'alert-box' + (diffPosStars >= 2 ? ' danger' : diffPosStars >= 1 ? ' warning' : '');

            // 4. å·®å€¼è´Ÿå€¼ï¼ˆç©ºå¿ƒæ˜Ÿï¼‰
            let diffNegStars = 0;
            let diffNegDesc = '';
            if (diff <= -50) {
                diffNegStars = 3;
                diffNegDesc = 'æå¼ºç©ºå¤´ï¼';
            } else if (diff <= -20) {
                diffNegStars = 2;
                diffNegDesc = 'å¼ºç©ºå¤´';
            } else if (diff <= -10) {
                diffNegStars = 1;
                diffNegDesc = 'åç©ºå¤´';
            } else if (diff < 0) {
                diffNegDesc = 'å¾®ç©ºå¤´';
            } else {
                diffNegDesc = '-';
            }
            if (diff <= -10) {
                totalEmpty += diffNegStars;
            }

            document.getElementById('alertDiffNegativeValue').textContent = diff <= 0 ? diff : '-';
            if (diff <= -10) {
                document.getElementById('alertDiffNegativeStars').innerHTML = 
                    '<span class="star-empty">' + 'â˜†'.repeat(diffNegStars) + '</span>';
            } else {
                document.getElementById('alertDiffNegativeStars').textContent = '-';
            }
            document.getElementById('alertDiffNegativeDesc').textContent = diffNegDesc;
            document.getElementById('alertDiffNegative').className = 
                'alert-box' + (diffNegStars >= 2 ? ' danger' : diffNegStars >= 1 ? ' warning' : '');

            // 5. æŒä»“é‡ï¼ˆå®å¿ƒæ˜Ÿï¼‰
            let positionStars = 0;
            let positionDesc = '';
            if (position > 0) {
                if (position <= 91) {
                    positionStars = 3;
                    positionDesc = 'æä½æŒä»“ï¼';
                } else if (position > 91 && position < 95) {
                    positionStars = 2;
                    positionDesc = 'ä½æŒä»“';
                } else if (position >= 95 && position < 100) {
                    positionStars = 1;
                    positionDesc = 'åä½æŒä»“';
                } else {
                    positionDesc = 'æ­£å¸¸æŒä»“';
                }
                totalFilled += positionStars;
            } else {
                positionDesc = 'ç­‰å¾…æ•°æ®';
            }

            document.getElementById('alertPositionValue').innerHTML = 
                position > 0 ? `${position}<span style="font-size:14px;">äº¿</span>` : '-';
            if (positionStars > 0) {
                document.getElementById('alertPositionStars').innerHTML = 
                    '<span class="star-filled">' + 'â˜…'.repeat(positionStars) + '</span>';
            } else {
                document.getElementById('alertPositionStars').textContent = '-';
            }
            document.getElementById('alertPositionDesc').textContent = positionDesc;
            document.getElementById('alertPosition').className = 
                'alert-box' + (positionStars >= 2 ? ' danger' : positionStars >= 1 ? ' warning' : '');

            // 6. åšå¤šä¿¡å·ï¼ˆå®å¿ƒæ˜Ÿï¼‰
            let longSignalStars = 0;
            let longSignalDesc = '';
            if (longSignal >= 100) {
                longSignalStars = 3;
                longSignalDesc = 'æå¼ºåšå¤šï¼';
            } else if (longSignal >= 50) {
                longSignalStars = 2;
                longSignalDesc = 'å¼ºåšå¤š';
            } else if (longSignal >= 20) {
                longSignalStars = 1;
                longSignalDesc = 'ååšå¤š';
            } else {
                longSignalDesc = 'æ­£å¸¸';
            }
            totalFilled += longSignalStars;

            document.getElementById('alertLongSignalValue').textContent = longSignal;
            if (longSignalStars > 0) {
                document.getElementById('alertLongSignalStars').innerHTML = 
                    '<span class="star-filled">' + 'â˜…'.repeat(longSignalStars) + '</span>';
            } else {
                document.getElementById('alertLongSignalStars').textContent = '-';
            }
            document.getElementById('alertLongSignalDesc').textContent = longSignalDesc;
            document.getElementById('alertLongSignal').className = 
                'alert-box' + (longSignalStars >= 2 ? ' danger' : longSignalStars >= 1 ? ' warning' : '');

            // 7. åšç©ºä¿¡å·ï¼ˆç©ºå¿ƒæ˜Ÿï¼‰
            let shortSignalStars = 0;
            let shortSignalDesc = '';
            if (shortSignal >= 120) {
                shortSignalStars = 3;
                shortSignalDesc = 'æå¼ºåšç©ºï¼';
            } else if (shortSignal >= 50) {
                shortSignalStars = 2;
                shortSignalDesc = 'å¼ºåšç©º';
            } else if (shortSignal >= 30) {
                shortSignalStars = 1;
                shortSignalDesc = 'ååšç©º';
            } else {
                shortSignalDesc = 'æ­£å¸¸';
            }
            totalEmpty += shortSignalStars;

            document.getElementById('alertShortSignalValue').textContent = shortSignal;
            if (shortSignalStars > 0) {
                document.getElementById('alertShortSignalStars').innerHTML = 
                    '<span class="star-empty">' + 'â˜†'.repeat(shortSignalStars) + '</span>';
            } else {
                document.getElementById('alertShortSignalStars').textContent = '-';
            }
            document.getElementById('alertShortSignalDesc').textContent = shortSignalDesc;
            document.getElementById('alertShortSignal').className = 
                'alert-box' + (shortSignalStars >= 2 ? ' danger' : shortSignalStars >= 1 ? ' warning' : '');

            // 8. åªæœ‰æ€¥æ¶¨ï¼ˆæ˜¾ç¤ºæ•°é‡å’Œå¸åï¼‰
            document.getElementById('alertOnlyRushUpValue').textContent = onlyRushUpCount;
            document.getElementById('alertOnlyRushUpStars').textContent = onlyRushUpCount > 0 ? 'ğŸ“Š' : '-';
            
            // åœ¨æè¿°ä¸­æ˜¾ç¤ºå¸å
            if (onlyRushUpCount > 0) {
                const coinNames = onlyRushUpCoins.map(c => c.symbol).join(', ');
                document.getElementById('alertOnlyRushUpDesc').innerHTML = 
                    `${onlyRushUpCount}ä¸ªå¸<br><span style="color: #4a9eff; font-weight: 700;">${coinNames}</span>`;
            } else {
                document.getElementById('alertOnlyRushUpDesc').textContent = 'æ— æ•°æ®';
            }
            
            // åŒæ—¶åœ¨åˆ—è¡¨å®¹å™¨ä¸­æ˜¾ç¤ºæ ‡ç­¾å½¢å¼
            const onlyRushUpList = onlyRushUpCoins.map(c => 
                `<span class="coin-tag">${c.symbol}</span>`
            ).join('');
            document.getElementById('alertOnlyRushUpList').innerHTML = onlyRushUpList;
            console.log('åªæœ‰æ€¥æ¶¨å¸ç§:', onlyRushUpCoins.length, onlyRushUpList);

            // 9. æ€¥æ¶¨>æ€¥è·Œï¼ˆæ˜¾ç¤ºæ•°é‡å’Œå¸åï¼‰
            document.getElementById('alertUpGreaterDownValue').textContent = upGreaterDownCount;
            document.getElementById('alertUpGreaterDownStars').textContent = upGreaterDownCount > 0 ? 'ğŸ“Š' : '-';
            
            // åœ¨æè¿°ä¸­æ˜¾ç¤ºå¸å
            if (upGreaterDownCount > 0) {
                const coinNames = upGreaterDownCoins.map(c => c.symbol).join(', ');
                document.getElementById('alertUpGreaterDownDesc').innerHTML = 
                    `${upGreaterDownCount}ä¸ªå¸<br><span style="color: #4a9eff; font-weight: 700;">${coinNames}</span>`;
            } else {
                document.getElementById('alertUpGreaterDownDesc').textContent = 'æ— æ•°æ®';
            }
            
            // åŒæ—¶åœ¨åˆ—è¡¨å®¹å™¨ä¸­æ˜¾ç¤ºæ ‡ç­¾å½¢å¼
            const upGreaterDownList = upGreaterDownCoins.map(c => 
                `<span class="coin-tag">${c.symbol}</span>`
            ).join('');
            document.getElementById('alertUpGreaterDownList').innerHTML = upGreaterDownList;

            // 10. ä¼˜å…ˆçº§â‰¥4ï¼ˆæ˜¾ç¤ºæ•°é‡å’Œå¸åï¼‰
            document.getElementById('alertPriorityValue').textContent = priorityCount;
            document.getElementById('alertPriorityStars').textContent = priorityCount > 0 ? 'ğŸ“Š' : '-';
            
            // åœ¨æè¿°ä¸­æ˜¾ç¤ºå¸å
            if (priorityCount > 0) {
                const coinNames = priorityCoins.map(c => c.symbol).join(', ');
                document.getElementById('alertPriorityDesc').innerHTML = 
                    `${priorityCount}ä¸ªå¸<br><span style="color: #4a9eff; font-weight: 700;">${coinNames}</span>`;
            } else {
                document.getElementById('alertPriorityDesc').textContent = 'æ— æ•°æ®';
            }
            
            document.getElementById('alertPriority').className = 
                'alert-box' + (priorityCount >= 3 ? ' danger' : priorityCount >= 1 ? ' warning' : '');
            
            // åŒæ—¶åœ¨åˆ—è¡¨å®¹å™¨ä¸­æ˜¾ç¤ºæ ‡ç­¾å½¢å¼
            const priorityList = priorityCoins.map(c => 
                `<span class="coin-tag">${c.symbol}</span>`
            ).join('');
            document.getElementById('alertPriorityList').innerHTML = priorityList;

            // 11. åªæœ‰æ€¥è·Œï¼ˆæ˜¾ç¤ºæ•°é‡å’Œå¸åï¼‰
            document.getElementById('alertOnlyRushDownValue').textContent = onlyRushDownCount;
            document.getElementById('alertOnlyRushDownStars').textContent = onlyRushDownCount > 0 ? 'ğŸ“Š' : '-';
            
            // åœ¨æè¿°ä¸­æ˜¾ç¤ºå¸å
            if (onlyRushDownCount > 0) {
                const coinNames = onlyRushDownCoins.map(c => c.symbol).join(', ');
                document.getElementById('alertOnlyRushDownDesc').innerHTML = 
                    `${onlyRushDownCount}ä¸ªå¸<br><span style="color: #4a9eff; font-weight: 700;">${coinNames}</span>`;
            } else {
                document.getElementById('alertOnlyRushDownDesc').textContent = 'æ— æ•°æ®';
            }
            
            // åŒæ—¶åœ¨åˆ—è¡¨å®¹å™¨ä¸­æ˜¾ç¤ºæ ‡ç­¾å½¢å¼
            const onlyRushDownList = onlyRushDownCoins.map(c => 
                `<span class="coin-tag">${c.symbol}</span>`
            ).join('');
            document.getElementById('alertOnlyRushDownList').innerHTML = onlyRushDownList;

            // æ›´æ–°æ€»è®¡ï¼ˆåŒæ—¶æ›´æ–°æ ‡é¢˜æ å’Œåº•éƒ¨æ±‡æ€»ï¼‰
            document.getElementById('totalFilledStars').textContent = `${totalFilled} â˜…`;
            document.getElementById('totalEmptyStars').textContent = `${totalEmpty} â˜†`;
            document.getElementById('totalFilledStarsTop').textContent = totalFilled;
            document.getElementById('totalEmptyStarsTop').textContent = totalEmpty;

            console.log(`æ˜Ÿçº§ç»Ÿè®¡ - å®å¿ƒ: ${totalFilled}â˜…, ç©ºå¿ƒ: ${totalEmpty}â˜†`);
            console.log(`å¸ç§ç»Ÿè®¡ - åªæ¶¨: ${onlyRushUpCount}, æ¶¨>è·Œ: ${upGreaterDownCount}, ä¼˜å…ˆçº§: ${priorityCount}, åªè·Œ: ${onlyRushDownCount}`);
        }

        function initChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'æ€¥æ¶¨',
                            data: [],
                            borderColor: '#ff4444',
                            backgroundColor: 'rgba(255, 68, 68, 0.2)',
                            borderWidth: 3,
                            pointRadius: 7,
                            pointHoverRadius: 12,
                            pointBackgroundColor: '#ff4444',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 3,
                            pointHoverBorderWidth: 5,
                            pointHoverBackgroundColor: '#ff6666',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'æ€¥è·Œ',
                            data: [],
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0, 255, 136, 0.2)',
                            borderWidth: 3,
                            pointRadius: 7,
                            pointHoverRadius: 12,
                            pointBackgroundColor: '#00ff88',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 3,
                            pointHoverBorderWidth: 5,
                            pointHoverBackgroundColor: '#33ffaa',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'å·®å€¼ (æ€¥æ¶¨-æ€¥è·Œ)',
                            data: [],
                            borderColor: '#ffaa00',
                            backgroundColor: 'rgba(255, 170, 0, 0.1)',
                            borderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 10,
                            pointBackgroundColor: '#ffaa00',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverBorderWidth: 4,
                            pointHoverBackgroundColor: '#ffcc33',
                            tension: 0.4,
                            fill: false,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'è®¡æ¬¡',
                            data: [],
                            borderColor: '#00ccff',
                            backgroundColor: 'rgba(0, 204, 255, 0.2)',
                            borderWidth: 3,
                            pointRadius: 7,
                            pointHoverRadius: 12,
                            pointBackgroundColor: '#00ccff',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 3,
                            pointHoverBorderWidth: 5,
                            pointHoverBackgroundColor: '#33ddff',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#eee',
                                font: { size: 14 },
                                padding: 15
                            }
                        },
                        title: {
                            display: true,
                            text: 'æ€¥æ¶¨/æ€¥è·Œå†å²è¶‹åŠ¿å›¾ï¼ˆä»Šæ—¥æ•°æ®ï¼‰',
                            color: '#4a9eff',
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#4a9eff',
                            bodyColor: '#eee',
                            borderColor: '#4a9eff',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            reverse: true,  // âœ… åè½¬Xè½´ï¼šå·¦è¾¹æ—©ï¼Œå³è¾¹æ™š
                            ticks: {
                                color: '#888',
                                font: { size: 12 },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                color: '#888',
                                font: { size: 12 },
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'æ€¥æ¶¨/æ€¥è·Œ/å·®å€¼',
                                color: '#aaa',
                                font: { size: 13 }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            ticks: {
                                color: '#888',
                                font: { size: 12 },
                                stepSize: 1
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'è®¡æ¬¡',
                                color: '#aaa',
                                font: { size: 13 }
                            }
                        }
                    }
                }
            });
        }

        async function loadHistoryData() {
            try {
                const today = new Date().toISOString().split('T')[0];
                // âœ… ä¼˜åŒ–ï¼šåªæŸ¥è¯¢æœ€è¿‘50æ¡è®°å½•ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢æ—¶é—´
                const response = await fetch(`/api/history/query?start_time=${today}%2000:00:00&end_time=${today}%2023:59:59&limit=50`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    historyData = result.data.map(d => ({
                        time: d.record_time.split(' ')[1].substring(0, 5),
                        rushUp: parseInt(d.rush_up) || 0,
                        rushDown: parseInt(d.rush_down) || 0,
                        diff: (parseInt(d.rush_up) || 0) - (parseInt(d.rush_down) || 0),
                        count: parseInt(d.count_times) || 0
                    }));
                    
                    // åªä¿ç•™æœ€è¿‘50ä¸ªç‚¹
                    if (historyData.length > MAX_HISTORY_POINTS) {
                        historyData = historyData.slice(-MAX_HISTORY_POINTS);
                    }
                    
                    updateChartWithHighlight();
                    console.log(`ğŸ“Š å·²åŠ è½½ ${historyData.length} æ¡å†å²æ•°æ®`);
                }
            } catch (error) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
            }
        }

        async function updateChart(data) {
            // âœ… ä¼˜åŒ–ï¼šåªåœ¨åå°å¼‚æ­¥åŠ è½½å†å²æ•°æ®ï¼Œä¸é˜»å¡UIæ›´æ–°
            loadHistoryData();  // ä¸ä½¿ç”¨ awaitï¼Œè®©å®ƒå¼‚æ­¥åŠ è½½
        }

        function updateChartWithHighlight() {
            // æ›´æ–°å›¾è¡¨æ•°æ®
            trendChart.data.labels = historyData.map(d => d.time);
            trendChart.data.datasets[0].data = historyData.map(d => d.rushUp);
            trendChart.data.datasets[1].data = historyData.map(d => d.rushDown);
            trendChart.data.datasets[2].data = historyData.map(d => d.diff);
            trendChart.data.datasets[3].data = historyData.map(d => d.count);
            
            // ğŸŒŸ åº”ç”¨æ¡ä»¶é«˜äº®
            let hasMarkedRush10 = false;
            let hasMarkedDiff20 = false;
            let hasMarkedDiff50 = false;
            
            const rushUpPointRadius = [];
            const rushUpPointBorderWidth = [];
            const rushUpPointBackgroundColor = [];
            const rushDownPointRadius = [];
            const rushDownPointBorderWidth = [];
            const rushDownPointBackgroundColor = [];
            const diffPointRadius = [];
            const diffPointBorderWidth = [];
            const diffPointBackgroundColor = [];
            
            historyData.forEach((d, index) => {
                // é»˜è®¤æ ·å¼
                let rushUpRadius = 7;
                let rushUpBorderWidth = 3;
                let rushUpColor = '#ff4444';
                
                let rushDownRadius = 7;
                let rushDownBorderWidth = 3;
                let rushDownColor = '#00ff88';
                
                let diffRadius = 6;
                let diffBorderWidth = 2;
                let diffColor = '#ffaa00';
                
                // æ¡ä»¶1: æ€¥æ¶¨>=10 æˆ– æ€¥è·Œ>=10
                if (!hasMarkedRush10) {
                    if (d.rushUp >= 10) {
                        rushUpRadius = 14;
                        rushUpBorderWidth = 6;
                        rushUpColor = '#ffff00';
                        hasMarkedRush10 = true;
                    } else if (d.rushDown >= 10) {
                        rushDownRadius = 14;
                        rushDownBorderWidth = 6;
                        rushDownColor = '#ffff00';
                        hasMarkedRush10 = true;
                    }
                }
                
                // æ¡ä»¶2: å·®å€¼>=50
                if (!hasMarkedDiff50 && Math.abs(d.diff) >= 50) {
                    diffRadius = 16;
                    diffBorderWidth = 7;
                    diffColor = '#ff00ff';
                    hasMarkedDiff50 = true;
                    hasMarkedDiff20 = true;
                }
                // æ¡ä»¶3: å·®å€¼>=20
                else if (!hasMarkedDiff20 && Math.abs(d.diff) >= 20) {
                    diffRadius = 14;
                    diffBorderWidth = 6;
                    diffColor = '#ff6600';
                    hasMarkedDiff20 = true;
                }
                
                rushUpPointRadius.push(rushUpRadius);
                rushUpPointBorderWidth.push(rushUpBorderWidth);
                rushUpPointBackgroundColor.push(rushUpColor);
                
                rushDownPointRadius.push(rushDownRadius);
                rushDownPointBorderWidth.push(rushDownBorderWidth);
                rushDownPointBackgroundColor.push(rushDownColor);
                
                diffPointRadius.push(diffRadius);
                diffPointBorderWidth.push(diffBorderWidth);
                diffPointBackgroundColor.push(diffColor);
            });
            
            // åº”ç”¨æ ·å¼
            trendChart.data.datasets[0].pointRadius = rushUpPointRadius;
            trendChart.data.datasets[0].pointBorderWidth = rushUpPointBorderWidth;
            trendChart.data.datasets[0].pointBackgroundColor = rushUpPointBackgroundColor;
            
            trendChart.data.datasets[1].pointRadius = rushDownPointRadius;
            trendChart.data.datasets[1].pointBorderWidth = rushDownPointBorderWidth;
            trendChart.data.datasets[1].pointBackgroundColor = rushDownPointBackgroundColor;
            
            trendChart.data.datasets[2].pointRadius = diffPointRadius;
            trendChart.data.datasets[2].pointBorderWidth = diffPointBorderWidth;
            trendChart.data.datasets[2].pointBackgroundColor = diffPointBackgroundColor;
            
            trendChart.update();
        }

        async function forceRefreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            
            try {
                // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                refreshBtn.disabled = true;
                refreshIcon.classList.add('refreshing');
                refreshIcon.textContent = 'â³';
                
                console.log('ğŸ”„ å¼€å§‹å¼ºåˆ¶åˆ·æ–°æ•°æ®...');
                
                const response = await fetch('/api/home-data/force-refresh');
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'æ•°æ®åˆ·æ–°å¤±è´¥');
                }

                console.log('âœ… æ•°æ®åˆ·æ–°æˆåŠŸ:', result.message);
                
                const data = result.data;

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('rushUp').textContent = data.stats.rushUp || 0;
                document.getElementById('rushDown').textContent = data.stats.rushDown || 0;
                document.getElementById('status').textContent = data.stats.status || '-';
                document.getElementById('ratio').textContent = data.stats.ratio || '-';
                document.getElementById('greenCount').textContent = data.stats.greenCount || 0;
                document.getElementById('percentage').textContent = data.stats.percentage || '-';
                document.getElementById('updateTime').textContent = `æ›´æ–°æ—¶é—´: ${data.updateTime}`;

                // æ›´æ–°æ˜Ÿçº§æé†’é¢æ¿ï¼ˆä¼ å…¥å¸ç§æ•°æ®ï¼‰
                updateAlertPanel(data.stats, data.coins);

                // æ›´æ–°æ›²çº¿å›¾
                updateChart(data);

                // æ›´æ–°è¡¨æ ¼æ•°æ®
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                data.coins.forEach(coin => {
                    const row = document.createElement('tr');
                    
                    const changeClass = parseFloat(coin.change) > 0 ? 'positive' : 
                                       parseFloat(coin.change) < 0 ? 'negative' : 'neutral';
                    
                    const change24hClass = parseFloat(coin.change24h) > 0 ? 'positive' : 
                                          parseFloat(coin.change24h) < 0 ? 'negative' : 'neutral';

                    // è®¡ç®—ä¼˜å…ˆçº§
                    const priority = calculatePriority(coin.ratio1, coin.ratio2);

                    row.innerHTML = `
                        <td><span class="priority-badge priority-${priority.level}">${priority.text}</span></td>
                        <td>${coin.index}</td>
                        <td class="symbol">${coin.symbol}</td>
                        <td class="${changeClass}">${coin.change}</td>
                        <td>${coin.rushUp > 0 ? `<span class="rush-up">${coin.rushUp}</span>` : coin.rushUp}</td>
                        <td>${coin.rushDown > 0 ? `<span class="rush-down">${coin.rushDown}</span>` : coin.rushDown}</td>
                        <td>${coin.updateTime}</td>
                        <td>${coin.highPrice}</td>
                        <td>${coin.highTime}</td>
                        <td>${coin.decline}</td>
                        <td class="${change24hClass}">${coin.change24h}</td>
                        <td>${coin.rank}</td>
                        <td>${coin.currentPrice}</td>
                        <td>${coin.ratio1}</td>
                        <td>${coin.ratio2}</td>
                    `;
                    
                    tbody.appendChild(row);
                });

                // æ˜¾ç¤ºè¡¨æ ¼
                document.getElementById('dataTable').style.display = 'table';
                document.getElementById('loadingMsg').style.display = 'none';
                document.getElementById('errorMsg').style.display = 'none';
                
                // é‡å¯å€’è®¡æ—¶
                startCountdown(600); // 10åˆ†é’Ÿ

                console.log('ğŸ“Š æ•°æ®åˆ·æ–°å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ æ•°æ®åˆ·æ–°å¤±è´¥:', error);
                document.getElementById('errorMsg').textContent = `åˆ·æ–°å¤±è´¥: ${error.message}`;
                document.getElementById('errorMsg').style.display = 'block';
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.disabled = false;
                refreshIcon.classList.remove('refreshing');
                refreshIcon.textContent = 'ğŸ”„';
            }
        }

        async function loadData(retryCount = 0) {
            try {
                const response = await fetch('/api/home-data');
                const result = await response.json();

                if (!result.success) {
                    // å¦‚æœæ•°æ®å°šæœªåŠ è½½ä¸”é‡è¯•æ¬¡æ•°<3ï¼Œåˆ™è‡ªåŠ¨é‡è¯•
                    if (result.error && result.error.includes('æ•°æ®å°šæœªåŠ è½½') && retryCount < 3) {
                        console.log(`â³ æ•°æ®å°šæœªå‡†å¤‡å¥½ï¼Œ${3-retryCount}ç§’åé‡è¯•... (${retryCount + 1}/3)`);
                        document.getElementById('loadingMsg').textContent = `â³ æ­£åœ¨ç­‰å¾…æ•°æ®å‡†å¤‡... (${retryCount + 1}/3)`;
                        await new Promise(resolve => setTimeout(resolve, 3000)); // ç­‰å¾…3ç§’
                        return loadData(retryCount + 1); // é€’å½’é‡è¯•
                    }
                    throw new Error(result.error || 'æ•°æ®åŠ è½½å¤±è´¥');
                }

                const data = result.data;

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('rushUp').textContent = data.stats.rushUp || 0;
                document.getElementById('rushDown').textContent = data.stats.rushDown || 0;
                document.getElementById('status').textContent = data.stats.status || '-';
                document.getElementById('ratio').textContent = data.stats.ratio || '-';
                document.getElementById('greenCount').textContent = data.stats.greenCount || 0;
                document.getElementById('percentage').textContent = data.stats.percentage || '-';
                document.getElementById('updateTime').textContent = `æ›´æ–°æ—¶é—´: ${data.updateTime}`;

                // æ›´æ–°æ˜Ÿçº§æé†’é¢æ¿ï¼ˆä¼ å…¥å¸ç§æ•°æ®ï¼‰
                updateAlertPanel(data.stats, data.coins);

                // æ›´æ–°æ›²çº¿å›¾
                updateChart(data);

                // æ›´æ–°è¡¨æ ¼æ•°æ®
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                data.coins.forEach(coin => {
                    const row = document.createElement('tr');
                    
                    const changeClass = parseFloat(coin.change) > 0 ? 'positive' : 
                                       parseFloat(coin.change) < 0 ? 'negative' : 'neutral';
                    
                    const change24hClass = parseFloat(coin.change24h) > 0 ? 'positive' : 
                                          parseFloat(coin.change24h) < 0 ? 'negative' : 'neutral';

                    // è®¡ç®—ä¼˜å…ˆçº§
                    const priority = calculatePriority(coin.ratio1, coin.ratio2);

                    row.innerHTML = `
                        <td><span class="priority-badge priority-${priority.level}">${priority.text}</span></td>
                        <td>${coin.index}</td>
                        <td class="symbol">${coin.symbol}</td>
                        <td class="${changeClass}">${coin.change}</td>
                        <td>${coin.rushUp > 0 ? `<span class="rush-up">${coin.rushUp}</span>` : coin.rushUp}</td>
                        <td>${coin.rushDown > 0 ? `<span class="rush-down">${coin.rushDown}</span>` : coin.rushDown}</td>
                        <td>${coin.updateTime}</td>
                        <td>${coin.highPrice}</td>
                        <td>${coin.highTime}</td>
                        <td class="negative">${coin.decline}</td>
                        <td class="${change24hClass}">${coin.change24h}</td>
                        <td>${coin.rank}</td>
                        <td>${coin.currentPrice}</td>
                        <td>${coin.ratio1}</td>
                        <td>${coin.ratio2}</td>
                    `;
                    
                    tbody.appendChild(row);
                });

                // æ˜¾ç¤ºè¡¨æ ¼ï¼Œéšè—åŠ è½½æç¤º
                document.getElementById('loadingMsg').style.display = 'none';
                document.getElementById('errorMsg').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('loadingMsg').style.display = 'none';
                document.getElementById('errorMsg').textContent = 'âŒ æ•°æ®åŠ è½½å¤±è´¥: ' + error.message;
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        function startCountdown() {
            let seconds = 600; // 10åˆ†é’Ÿ = 600ç§’
            
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            countdownTimer = setInterval(() => {
                seconds--;
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById('countdown').textContent = 
                    `(${minutes}:${secs.toString().padStart(2, '0')} ååˆ·æ–°)`;
                
                if (seconds <= 0) {
                    seconds = 600;
                    loadData();
                }
            }, 1000);
        }

        function startAutoRefresh() {
            // æ¯10åˆ†é’Ÿå¼ºåˆ¶åˆ·æ–°
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            autoRefreshTimer = setInterval(() => {
                console.log('10åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°...');
                loadData();
            }, 10 * 60 * 1000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            initChart();
            
            // âœ… ä¼˜åŒ–ï¼šå¹¶è¡ŒåŠ è½½æ•°æ®ï¼Œä¸é˜»å¡
            // å…ˆåŠ è½½æœ€æ–°æ•°æ®ï¼ˆæ˜¾ç¤ºè¡¨æ ¼ï¼‰ï¼ŒåŒæ—¶åå°åŠ è½½å†å²æ•°æ®ï¼ˆæ˜¾ç¤ºå›¾è¡¨ï¼‰
            loadData();  // ç«‹å³åŠ è½½æœ€æ–°æ•°æ®ï¼ˆä¸ç­‰å¾…ï¼‰
            loadHistoryData();  // å¹¶è¡ŒåŠ è½½å†å²æ•°æ®ï¼ˆä¸ç­‰å¾…ï¼‰
            
            startAutoRefresh();
            startCountdown();
        });
    </script>
</body>
</html>
