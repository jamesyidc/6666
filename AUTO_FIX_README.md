# 自动修复系统 - 使用说明

**创建时间**: 2025-12-03  
**版本**: 1.0  

---

## 📋 功能概述

自动修复系统每小时执行一次，自动维护和修复沙箱环境，确保服务稳定运行。

### 主要功能

1. **🧹 清理硬盘空间**
   - 清理 `/tmp` 临时文件（保留7天内）
   - 清理旧日志文件（保留7天内）
   - 清理 Python 缓存（`__pycache__`, `*.pyc`, `*.pyo`）
   - 清理 npm 缓存
   - 清理 apt 缓存

2. **📡 服务健康检查与修复**
   - 检查 3000 端口服务状态，异常时自动重启
   - 检查 8080 端口服务状态，异常时自动重启
   - 检查 5003 端口服务状态（主服务），异常时自动重启
   - 检查所有端口服务进程健康状态

3. **🔄 PM2 服务管理**
   - 检查 PM2 守护进程状态
   - 自动重启 errored 或 stopped 状态的服务
   - 显示所有 PM2 管理的服务状态

4. **📊 系统资源监控**
   - CPU 使用率监控
   - 内存使用率监控
   - 磁盘使用率监控
   - 网络连接状态检查

5. **🧠 内存优化**
   - 清理系统内存缓存（需要 root 权限）

---

## 🚀 快速开始

### 启动自动修复守护进程

```bash
cd /home/user/webapp
bash start_auto_fix.sh
```

**首次启动会**：
- 立即执行一次完整的自动修复
- 启动守护进程，每小时自动执行一次
- 创建日志文件记录所有操作

### 停止守护进程

```bash
cd /home/user/webapp
bash stop_auto_fix.sh
```

### 手动执行一次修复

```bash
cd /home/user/webapp
bash auto_fix_hourly.sh
```

---

## 📂 文件说明

### 核心脚本

| 文件名 | 说明 |
|--------|------|
| `auto_fix_hourly.sh` | 核心修复脚本，执行所有修复任务 |
| `auto_fix_daemon.sh` | 守护进程，每小时调用一次修复脚本 |
| `start_auto_fix.sh` | 启动守护进程的便捷脚本 |
| `stop_auto_fix.sh` | 停止守护进程的便捷脚本 |

### 服务启动脚本

| 文件名 | 说明 |
|--------|------|
| `start_3000.sh` | 启动 3000 端口服务 |
| `start_8080.sh` | 启动 8080 端口服务 |

### 日志文件

| 文件名 | 说明 |
|--------|------|
| `auto_fix.log` | 修复任务执行日志 |
| `auto_fix_daemon.log` | 守护进程日志 |
| `auto_fix_daemon.pid` | 守护进程 PID 文件 |
| `service_3000.log` | 3000 端口服务日志 |
| `service_8080.log` | 8080 端口服务日志 |

---

## 📊 使用示例

### 示例1: 启动守护进程

```bash
$ bash start_auto_fix.sh

==========================================
🚀 启动自动修复守护进程
==========================================
启动守护进程...
✅ 守护进程启动成功!

📊 进程信息:
  - PID: 12345
  - 日志文件: /home/user/webapp/auto_fix_daemon.log
  - 执行间隔: 每小时

📝 管理命令:
  - 查看日志: tail -f /home/user/webapp/auto_fix_daemon.log
  - 查看状态: ps aux | grep auto_fix_daemon
  - 停止服务: bash /home/user/webapp/stop_auto_fix.sh

🔄 首次修复任务已开始执行，请查看日志...
==========================================
```

### 示例2: 查看实时日志

```bash
$ tail -f auto_fix.log

[2025-12-03 13:40:53] ==========================================
[2025-12-03 13:40:53] 🔧 开始执行每小时自动修复任务
[2025-12-03 13:40:53] ==========================================
[2025-12-03 13:40:53] 📦 1. 清理硬盘空间...
[2025-12-03 13:40:53]   ✅ 磁盘清理完成，当前使用率: 29%
[2025-12-03 13:40:59] 📡 2. 检查3000端口服务...
[2025-12-03 13:40:59]   ✅ 3000端口服务运行正常 (PID: 54321)
[2025-12-03 13:41:07] 📊 7. 系统资源状态:
[2025-12-03 13:41:07]   - CPU使用率: 25%
[2025-12-03 13:41:07]   - 内存使用率: 9.65%
[2025-12-03 13:41:07]   - 磁盘使用率: 29%
[2025-12-03 13:41:07] ==========================================
[2025-12-03 13:41:07] ✅ 每小时自动修复任务执行完成
[2025-12-03 13:41:07] ==========================================
```

### 示例3: 检查守护进程状态

```bash
$ ps aux | grep auto_fix_daemon
user  12345  0.0  0.0  auto_fix_daemon.sh
```

### 示例4: 停止守护进程

```bash
$ bash stop_auto_fix.sh

==========================================
🛑 停止自动修复守护进程
==========================================
PID文件: /home/user/webapp/auto_fix_daemon.pid
进程ID: 12345
停止进程...
✅ 守护进程已停止
PID文件已清理
==========================================
```

---

## 🔧 自定义配置

### 修改执行间隔

编辑 `auto_fix_daemon.sh`，修改 `sleep` 时间：

```bash
# 默认: 每小时 (3600秒)
sleep 3600

# 改为每30分钟
sleep 1800

# 改为每2小时
sleep 7200
```

### 添加自定义服务监控

编辑 `auto_fix_hourly.sh`，在适当位置添加：

```bash
# 检查自定义端口（例如9000）
log "📡 检查9000端口服务..."
PORT_9000=$(lsof -ti:9000 2>/dev/null)
if [ -z "$PORT_9000" ]; then
    log "  ⚠️  9000端口无服务运行"
    # 添加启动逻辑
else
    log "  ✅ 9000端口服务运行正常 (PID: $PORT_9000)"
fi
```

### 配置服务启动脚本

编辑 `start_3000.sh` 或 `start_8080.sh`，根据您的项目类型配置：

```bash
# Node.js 项目示例
if [ -f "package.json" ]; then
    npm run dev &
fi

# Python 项目示例
if [ -f "server.py" ]; then
    python3 server.py &
fi

# 其他类型项目
# 添加您的启动命令
```

---

## 📈 监控与维护

### 查看修复历史

```bash
# 查看最近的修复记录
tail -100 auto_fix.log | grep "任务执行完成"

# 查看失败的修复
grep "❌\|失败\|异常" auto_fix.log

# 查看磁盘清理效果
grep "磁盘清理完成" auto_fix.log | tail -10
```

### 日志管理

日志文件自动轮转，当文件大小超过 10MB 时：
- 旧日志重命名为 `*.log.old`
- 创建新的日志文件

手动清理旧日志：
```bash
rm -f /home/user/webapp/*.log.old
```

---

## ⚠️ 注意事项

### 权限要求

- 某些操作需要 root 权限（如清理内存缓存）
- 如果没有权限，会跳过并在日志中记录

### 服务启动失败

如果服务启动失败，检查：
1. 启动脚本 `start_3000.sh` / `start_8080.sh` 配置是否正确
2. 项目依赖是否已安装
3. 端口是否被其他进程占用
4. 查看服务日志 `service_3000.log` / `service_8080.log`

### 磁盘空间不足

如果磁盘使用率持续高于 80%：
1. 检查日志文件是否过大
2. 检查是否有大文件未清理
3. 手动执行 `du -sh /home/user/* | sort -h` 查找大文件

---

## 🐛 故障排查

### 守护进程无法启动

```bash
# 检查是否已经在运行
ps aux | grep auto_fix_daemon

# 查看启动日志
tail -50 auto_fix_daemon.log

# 手动清理 PID 文件
rm -f auto_fix_daemon.pid

# 重新启动
bash start_auto_fix.sh
```

### 服务频繁重启

```bash
# 查看修复日志
grep "重启" auto_fix.log | tail -20

# 检查服务日志
tail -50 service_3000.log
tail -50 service_8080.log

# 可能需要调整健康检查逻辑
```

### 日志文件过大

```bash
# 手动轮转日志
mv auto_fix.log auto_fix.log.old
touch auto_fix.log

# 或者直接清空
> auto_fix.log
```

---

## 📞 支持

如有问题，请检查：
1. 日志文件 `auto_fix.log`
2. 守护进程日志 `auto_fix_daemon.log`
3. 各服务日志文件

---

## 📋 更新日志

### v1.0 (2025-12-03)
- ✅ 首次发布
- ✅ 支持每小时自动修复
- ✅ 磁盘清理功能
- ✅ 服务健康检查
- ✅ PM2 服务管理
- ✅ 系统资源监控
- ✅ 守护进程模式

---

**最后更新**: 2025-12-03  
**维护者**: System Admin
