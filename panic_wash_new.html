<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ææ…Œæ¸…æ´—æŒ‡æ ‡ - ç‹¬ç«‹è®¡ç®—</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #4a9eff;
            margin-bottom: 10px;
            font-size: 32px;
            text-shadow: 0 0 10px rgba(74, 158, 255, 0.5);
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-link {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 10px;
            background: rgba(74, 158, 255, 0.2);
            border: 1px solid rgba(74, 158, 255, 0.5);
            border-radius: 8px;
            color: #4a9eff;
            text-decoration: none;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background: rgba(74, 158, 255, 0.3);
            transform: translateY(-2px);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(74, 158, 255, 0.2);
        }

        .stat-label {
            font-size: 14px;
            color: #888;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4a9eff;
        }

        .stat-value.red {
            color: #ff4757;
        }

        .stat-value.green {
            color: #00ff88;
        }

        .stat-value.yellow {
            color: #ffa502;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            color: #4a9eff;
            margin-bottom: 15px;
            text-align: center;
        }

        .update-info {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
        }

        .formula {
            background: rgba(74, 158, 255, 0.1);
            border-left: 3px solid #4a9eff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .formula-title {
            color: #4a9eff;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .formula-content {
            color: #ccc;
            font-family: 'Courier New', monospace;
        }

        .refresh-btn {
            display: block;
            margin: 20px auto;
            padding: 12px 30px;
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 158, 255, 0.4);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(74, 158, 255, 0.3);
            border-top-color: #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ ææ…Œæ¸…æ´—æŒ‡æ ‡</h1>
        <div class="subtitle">åŸºäºçˆ†ä»“æ•°æ®ç‹¬ç«‹è®¡ç®— | æ¯3åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡</div>

        <div class="nav-links">
            <a href="/" class="nav-link">â† è¿”å›ä¸»é¡µ</a>
            <a href="/signal" class="nav-link">ä¿¡å·ç›‘æ§</a>
        </div>

        <div class="formula">
            <div class="formula-title">ğŸ“ è®¡ç®—å…¬å¼</div>
            <div class="formula-content">
                ææ…Œæ¸…æ´—æŒ‡æ•° = (24å°æ—¶çˆ†ä»“äººæ•°/ä¸‡) / (å…¨ç½‘æŒä»“é‡/äº¿) Ã— 100%<br>
                ç¤ºä¾‹: 8.5431ä¸‡äºº / 95.79äº¿ = 8.92%<br>
                æ•°æ®æ¥æº: https://history.btc123.fans/baocang/
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
        </div>

        <div id="content" style="display: none;">
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-label">ğŸ’° 1å°æ—¶çˆ†ä»“é‡‘é¢</div>
                    <div class="stat-value" id="hour1Amount">-</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ğŸ’¸ 24å°æ—¶çˆ†ä»“é‡‘é¢</div>
                    <div class="stat-value" id="hour24Amount">-</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ğŸ‘¥ 24å°æ—¶çˆ†ä»“äººæ•°</div>
                    <div class="stat-value yellow" id="hour24People">-</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ğŸ¦ å…¨ç½‘æŒä»“é‡æ€»è®¡</div>
                    <div class="stat-value" id="totalPosition">-</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ğŸ”¥ ææ…Œæ¸…æ´—æŒ‡æ•°</div>
                    <div class="stat-value red" id="panicIndex">-</div>
                </div>
            </div>

            <button class="refresh-btn" onclick="refreshData()">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>

            <!-- å†å²æ•°æ®æŸ¥è¯¢ -->
            <div style="margin: 30px 0; padding: 20px; background: rgba(74, 158, 255, 0.1); border-radius: 10px; border: 1px solid rgba(74, 158, 255, 0.3);">
                <h3 style="color: #4a9eff; margin-bottom: 20px;">ğŸ” å†å²æ•°æ®æŸ¥è¯¢</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: end;">
                    <div>
                        <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="startDate" style="padding: 8px 12px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff;">
                    </div>
                    <div>
                        <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">å¼€å§‹æ—¶é—´</label>
                        <input type="time" id="startTime" value="00:00" style="padding: 8px 12px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff;">
                    </div>
                    <div>
                        <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="endDate" style="padding: 8px 12px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff;">
                    </div>
                    <div>
                        <label style="display: block; color: #888; margin-bottom: 5px; font-size: 14px;">ç»“æŸæ—¶é—´</label>
                        <input type="time" id="endTime" value="23:59" style="padding: 8px 12px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff;">
                    </div>
                    <button onclick="queryHistoryData()" style="padding: 10px 25px; background: #4a9eff; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        ğŸ” æŸ¥è¯¢
                    </button>
                    <button onclick="resetQuery()" style="padding: 10px 25px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; cursor: pointer; transition: all 0.3s;">
                        é‡ç½®
                    </button>
                </div>
                <div id="queryResult" style="margin-top: 20px; display: none;">
                    <div style="color: #4a9eff; font-weight: bold; margin-bottom: 10px;">æŸ¥è¯¢ç»“æœï¼š<span id="resultCount">0</span> æ¡è®°å½•</div>
                    <div id="queryStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">ğŸ“Š ææ…Œæ¸…æ´—æŒ‡æ•° & çˆ†ä»“æ•°æ®è¶‹åŠ¿ï¼ˆ24å°æ—¶ï¼‰</div>
                <canvas id="combinedChart"></canvas>
            </div>

            <div class="update-info">
                <p>æœ€åæ›´æ–°æ—¶é—´: <span id="updateTime">-</span></p>
                <p>è‡ªåŠ¨åˆ·æ–°é¢‘ç‡: æ¯30ç§’</p>
            </div>

            <!-- 30å¤©çˆ†ä»“æ—¥å† -->
            <div style="margin-top: 50px;">
                <h2 style="text-align: center; margin-bottom: 30px; color: #4a9eff;">ğŸ“… 30å¤©çˆ†ä»“æ•°æ®æ—¥å†</h2>
                
                <div style="overflow-x: auto; border-radius: 10px;">
                    <table id="calendar-table" style="width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.05);">
                        <thead>
                            <tr style="background: rgba(74, 158, 255, 0.2);">
                                <th style="padding: 15px; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.1); color: #fff;">æ—¥æœŸ</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.1); color: #ff4757;">å¤šå•çˆ†ä»“</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.1); color: #1dd1a1;">ç©ºå•çˆ†ä»“</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.1); color: #ffa502;">æ€»çˆ†ä»“</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.1); color: #fff;">è¶‹åŠ¿</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-tbody">
                            <tr>
                                <td colspan="5" style="padding: 30px; text-align: center; color: #888;">
                                    <div class="loading">ğŸ“Š åŠ è½½30å¤©æ•°æ®ä¸­...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 20px; text-align: center; color: #888; font-size: 12px;">
                    <p>ğŸ“Š æ•°æ®æ¥æº: <a href="https://history.btc123.fans/baocang/" target="_blank" style="color: #4a9eff; text-decoration: none;">BTC123 çˆ†ä»“æ•°æ®</a></p>
                    <p>ğŸ’¡ å¤šå•çˆ†ä»“ = åšå¤šè¢«å¼ºå¹³ï¼ˆä»·æ ¼ä¸‹è·Œï¼‰| ç©ºå•çˆ†ä»“ = åšç©ºè¢«å¼ºå¹³ï¼ˆä»·æ ¼ä¸Šæ¶¨ï¼‰</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let combinedChart = null;

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num, decimals = 2) {
            if (num === null || num === undefined) return '-';
            return Number(num).toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        // æ ¼å¼åŒ–é‡‘é¢ï¼ˆä½¿ç”¨ä¸­æ–‡å•ä½ï¼šäº¿ã€ä¸‡ï¼‰
        function formatAmount(amount) {
            if (amount >= 1e8) {
                // å¤§äºç­‰äº1äº¿ï¼Œæ˜¾ç¤ºä¸º"XX.XXäº¿"
                return (amount / 1e8).toFixed(2) + 'äº¿';
            } else if (amount >= 1e4) {
                // å¤§äºç­‰äº1ä¸‡ï¼Œæ˜¾ç¤ºä¸º"XX.XXä¸‡"
                return (amount / 1e4).toFixed(2) + 'ä¸‡';
            } else {
                // å°äº1ä¸‡ï¼Œæ˜¾ç¤ºåŸå€¼
                return formatNumber(amount, 2);
            }
        }

        // åŠ è½½æœ€æ–°æ•°æ®
        async function loadLatestData() {
            try {
                const response = await fetch('/api/panic-wash/latest');
                const result = await response.json();

                if (result.success && result.data) {
                    const data = result.data;
                    
                    document.getElementById('hour1Amount').textContent = formatAmount(data.hour_1_amount);
                    document.getElementById('hour24Amount').textContent = formatAmount(data.hour_24_amount);
                    document.getElementById('hour24People').textContent = (data.hour_24_people / 10000).toFixed(2) + ' ä¸‡äºº';
                    document.getElementById('totalPosition').textContent = formatAmount(data.total_position);
                    document.getElementById('panicIndex').textContent = data.panic_index.toFixed(2) + '%';
                    document.getElementById('updateTime').textContent = data.record_time;

                    // æ˜¾ç¤ºå†…å®¹
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½å†å²æ•°æ®
        async function loadHistoryData() {
            try {
                const response = await fetch('/api/panic-wash/history');
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    updateCharts(result.data);
                }
            } catch (error) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°åˆå¹¶å›¾è¡¨
        function updateCharts(data) {
            const labels = data.map(d => {
                const time = new Date(d.record_time);
                return time.getHours().toString().padStart(2, '0') + ':' + 
                       time.getMinutes().toString().padStart(2, '0');
            });

            // å‡†å¤‡æ‰€æœ‰æ•°æ®
            const panicData = data.map(d => d.panic_index.toFixed(2));
            const peopleData = data.map(d => d.hour_24_people / 10000); // è½¬æ¢ä¸ºä¸‡äºº
            const positionData = data.map(d => d.total_position / 1e8); // è½¬æ¢ä¸ºäº¿
            
            // é”€æ¯æ—§å›¾è¡¨
            if (combinedChart) {
                combinedChart.destroy();
            }

            // åˆ›å»ºåˆå¹¶å›¾è¡¨ï¼ˆä¸‰æ¡æ›²çº¿ï¼‰
            const ctx = document.getElementById('combinedChart').getContext('2d');
            combinedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ğŸ”¥ ææ…Œæ¸…æ´—æŒ‡æ•° (%)',
                            data: panicData,
                            borderColor: '#ff4757',
                            backgroundColor: 'rgba(255, 71, 87, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: 'ğŸ’° æŒä»“ä½™é¢ (äº¿)',
                            data: positionData,
                            borderColor: '#4a9eff',
                            backgroundColor: 'rgba(74, 158, 255, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: { 
                                color: '#eee',
                                font: { size: 13 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ææ…ŒæŒ‡æ•° (%)',
                                color: '#ff4757'
                            },
                            min: 9,            // æœ€å°å€¼ï¼š9%
                            max: 9.7,          // æœ€å¤§å€¼ï¼š9.7%
                            ticks: { 
                                color: '#ff4757',
                                stepSize: 0.1  // æ­¥é•¿ï¼š0.1%ï¼ˆ9.0, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7ï¼‰
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'æŒä»“ä½™é¢ (äº¿)',
                                color: '#4a9eff'
                            },
                            min: 95,           // æœ€å°å€¼ï¼š95äº¿
                            max: 98,           // æœ€å¤§å€¼ï¼š98äº¿
                            ticks: { 
                                color: '#4a9eff',
                                stepSize: 0.3  // æ­¥é•¿ï¼š0.3äº¿ï¼ˆ95.0, 95.3, 95.6, 95.9, 96.2, 96.5, 96.8, 97.1, 97.4, 97.7, 98.0ï¼‰
                            },
                            grid: { drawOnChartArea: false }
                        },
                        x: {
                            ticks: { 
                                color: '#888',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        }
                    }
                }
            });
        }

        // æ‰‹åŠ¨åˆ·æ–°æ•°æ®
        async function refreshData() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';

            try {
                const response = await fetch('/api/panic-wash/refresh', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    await loadLatestData();
                    await loadHistoryData();
                    alert('âœ… æ•°æ®åˆ·æ–°æˆåŠŸï¼');
                } else {
                    alert('âŒ åˆ·æ–°å¤±è´¥: ' + (result.message || result.error));
                }
            } catch (error) {
                alert('âŒ åˆ·æ–°å¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ æ‰‹åŠ¨åˆ·æ–°';
            }
        }

        // åŠ è½½30å¤©çˆ†ä»“æ—¥å†æ•°æ®
        async function load30DayCalendar() {
            try {
                const response = await fetch('https://api.btc123.fans/bicoin.php?from=30daybaocang&t=' + Date.now());
                const result = await response.json();
                
                if (result.code === 0 && result.data && result.data.list) {
                    const tbody = document.getElementById('calendar-tbody');
                    tbody.innerHTML = '';
                    
                    const list = result.data.list;
                    
                    list.forEach((item, index) => {
                        const sellAmount = item.sellAmount || 0;  // å¤šå•çˆ†ä»“
                        const buyAmount = item.buyAmount || 0;    // ç©ºå•çˆ†ä»“
                        const totalAmount = sellAmount + buyAmount;
                        
                        // åˆ¤æ–­è¶‹åŠ¿ï¼ˆä¸å‰ä¸€å¤©æ¯”è¾ƒï¼‰
                        let trendIcon = 'â–';
                        let trendColor = '#888';
                        if (index < list.length - 1) {
                            const prevTotal = (list[index + 1].sellAmount || 0) + (list[index + 1].buyAmount || 0);
                            if (totalAmount > prevTotal * 1.1) {
                                trendIcon = 'ğŸ“ˆ';
                                trendColor = '#ff4757';
                            } else if (totalAmount < prevTotal * 0.9) {
                                trendIcon = 'ğŸ“‰';
                                trendColor = '#1dd1a1';
                            }
                        }
                        
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        row.style.transition = 'background 0.2s';
                        row.onmouseover = function() { this.style.background = 'rgba(255,255,255,0.05)'; };
                        row.onmouseout = function() { this.style.background = 'transparent'; };
                        
                        row.innerHTML = `
                            <td style="padding: 12px; color: #eee;">${item.dateStr}</td>
                            <td style="padding: 12px; text-align: right; color: #ff4757; font-family: monospace;">
                                ${formatAmount(sellAmount)}
                            </td>
                            <td style="padding: 12px; text-align: right; color: #1dd1a1; font-family: monospace;">
                                ${formatAmount(buyAmount)}
                            </td>
                            <td style="padding: 12px; text-align: right; color: #ffa502; font-weight: bold; font-family: monospace;">
                                ${formatAmount(totalAmount)}
                            </td>
                            <td style="padding: 12px; text-align: center; font-size: 20px; color: ${trendColor};">
                                ${trendIcon}
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    console.log('âœ… 30å¤©çˆ†ä»“æ—¥å†åŠ è½½æˆåŠŸ:', list.length, 'æ¡è®°å½•');
                } else {
                    console.error('âŒ 30å¤©æ•°æ®æ ¼å¼é”™è¯¯');
                    document.getElementById('calendar-tbody').innerHTML = `
                        <tr><td colspan="5" style="padding: 30px; text-align: center; color: #ff4757;">
                            âŒ æ•°æ®åŠ è½½å¤±è´¥
                        </td></tr>
                    `;
                }
            } catch (error) {
                console.error('âŒ åŠ è½½30å¤©æ—¥å†å¤±è´¥:', error);
                document.getElementById('calendar-tbody').innerHTML = `
                    <tr><td colspan="5" style="padding: 30px; text-align: center; color: #ff4757;">
                        âŒ åŠ è½½å¤±è´¥: ${error.message}
                    </td></tr>
                `;
            }
        }

        // æŸ¥è¯¢å†å²æ•°æ®
        async function queryHistoryData() {
            const startDate = document.getElementById('startDate').value;
            const startTime = document.getElementById('startTime').value;
            const endDate = document.getElementById('endDate').value;
            const endTime = document.getElementById('endTime').value;

            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ');
                return;
            }

            const startDateTime = `${startDate} ${startTime}:00`;
            const endDateTime = `${endDate} ${endTime}:59`;

            try {
                const response = await fetch(`/api/panic-wash/query?start=${encodeURIComponent(startDateTime)}&end=${encodeURIComponent(endDateTime)}`);
                const result = await response.json();

                if (result.success && result.data) {
                    const data = result.data;
                    document.getElementById('resultCount').textContent = data.length;
                    
                    if (data.length > 0) {
                        // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                        const avgPanicIndex = (data.reduce((sum, d) => sum + d.panic_index, 0) / data.length).toFixed(2);
                        const maxPanicIndex = Math.max(...data.map(d => d.panic_index)).toFixed(2);
                        const minPanicIndex = Math.min(...data.map(d => d.panic_index)).toFixed(2);
                        const avgPosition = (data.reduce((sum, d) => sum + d.total_position, 0) / data.length / 1e8).toFixed(2);

                        document.getElementById('queryStats').innerHTML = `
                            <div style="background: rgba(255,71,87,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #ff4757;">
                                <div style="color: #888; font-size: 12px;">å¹³å‡ææ…ŒæŒ‡æ•°</div>
                                <div style="color: #ff4757; font-size: 24px; font-weight: bold; margin-top: 5px;">${avgPanicIndex}%</div>
                            </div>
                            <div style="background: rgba(255,71,87,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #ff4757;">
                                <div style="color: #888; font-size: 12px;">æœ€é«˜ææ…ŒæŒ‡æ•°</div>
                                <div style="color: #ff4757; font-size: 24px; font-weight: bold; margin-top: 5px;">${maxPanicIndex}%</div>
                            </div>
                            <div style="background: rgba(255,71,87,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #ff4757;">
                                <div style="color: #888; font-size: 12px;">æœ€ä½ææ…ŒæŒ‡æ•°</div>
                                <div style="color: #ff4757; font-size: 24px; font-weight: bold; margin-top: 5px;">${minPanicIndex}%</div>
                            </div>
                            <div style="background: rgba(74,158,255,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #4a9eff;">
                                <div style="color: #888; font-size: 12px;">å¹³å‡æŒä»“ä½™é¢</div>
                                <div style="color: #4a9eff; font-size: 24px; font-weight: bold; margin-top: 5px;">${avgPosition}äº¿</div>
                            </div>
                        `;
                        
                        document.getElementById('queryResult').style.display = 'block';
                        
                        // æ›´æ–°å›¾è¡¨æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
                        updateCharts(data);
                    } else {
                        alert('æŸ¥è¯¢æ—¶é—´æ®µå†…æ²¡æœ‰æ•°æ®');
                    }
                } else {
                    alert('æŸ¥è¯¢å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æŸ¥è¯¢å¤±è´¥ï¼š' + error.message);
                console.error('æŸ¥è¯¢å¤±è´¥:', error);
            }
        }

        // é‡ç½®æŸ¥è¯¢
        function resetQuery() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆä»Šå¤©ï¼‰
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            document.getElementById('startTime').value = '00:00';
            document.getElementById('endTime').value = '23:59';
            document.getElementById('queryResult').style.display = 'none';
            
            // é‡æ–°åŠ è½½24å°æ—¶æ•°æ®
            loadHistoryData();
        }

        // åˆå§‹åŒ–
        async function init() {
            await loadLatestData();
            await loadHistoryData();
            await load30DayCalendar();
            
            // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨é»˜è®¤å€¼ä¸ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;

            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(async () => {
                await loadLatestData();
                await loadHistoryData();
            }, 30000);
            
            // æ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡30å¤©æ—¥å†
            setInterval(async () => {
                await load30DayCalendar();
            }, 300000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
