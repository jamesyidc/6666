<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ææ…Œæ¸…æ´—æŒ‡æ ‡ - ç‹¬ç«‹è®¡ç®—</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #4a9eff;
            margin-bottom: 10px;
            font-size: 32px;
            text-shadow: 0 0 10px rgba(74, 158, 255, 0.5);
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-link {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 10px;
            background: rgba(74, 158, 255, 0.2);
            border: 1px solid rgba(74, 158, 255, 0.5);
            border-radius: 8px;
            color: #4a9eff;
            text-decoration: none;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background: rgba(74, 158, 255, 0.3);
            transform: translateY(-2px);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(74, 158, 255, 0.2);
        }

        .stat-label {
            font-size: 14px;
            color: #888;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4a9eff;
        }

        .stat-value.red {
            color: #ff4757;
        }

        .stat-value.green {
            color: #00ff88;
        }

        .stat-value.yellow {
            color: #ffa502;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            color: #4a9eff;
            margin-bottom: 15px;
            text-align: center;
        }

        .update-info {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
        }

        .formula {
            background: rgba(74, 158, 255, 0.1);
            border-left: 3px solid #4a9eff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .formula-title {
            color: #4a9eff;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .formula-content {
            color: #ccc;
            font-family: 'Courier New', monospace;
        }

        .refresh-btn {
            display: block;
            margin: 20px auto;
            padding: 12px 30px;
            background: linear-gradient(135deg, #4a9eff 0%, #667eea 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 158, 255, 0.4);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(74, 158, 255, 0.3);
            border-top-color: #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ ææ…Œæ¸…æ´—æŒ‡æ ‡</h1>
        <div class="subtitle">åŸºäºçˆ†ä»“æ•°æ®ç‹¬ç«‹è®¡ç®— | æ¯3åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡</div>

        <div class="nav-links">
            <a href="/" class="nav-link">â† è¿”å›ä¸»é¡µ</a>
            <a href="/signal" class="nav-link">ä¿¡å·ç›‘æ§</a>
        </div>

        <div class="formula">
            <div class="formula-title">ğŸ“ è®¡ç®—å…¬å¼</div>
            <div class="formula-content">
                ææ…Œæ¸…æ´—æŒ‡æ•° = (24å°æ—¶çˆ†ä»“äººæ•°/ä¸‡) / (å…¨ç½‘æŒä»“é‡/äº¿) Ã— 100%<br>
                ç¤ºä¾‹: 8.5431ä¸‡äºº / 95.79äº¿ = 8.92%<br>
                æ•°æ®æ¥æº: https://history.btc123.fans/baocang/
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
        </div>

        <div id="content" style="display: none;">
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-label">ğŸ’° 1å°æ—¶çˆ†ä»“é‡‘é¢</div>
                    <div class="stat-value" id="hour1Amount">-</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ğŸ’¸ 24å°æ—¶çˆ†ä»“é‡‘é¢</div>
                    <div class="stat-value" id="hour24Amount">-</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ğŸ‘¥ 24å°æ—¶çˆ†ä»“äººæ•°</div>
                    <div class="stat-value yellow" id="hour24People">-</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ğŸ¦ å…¨ç½‘æŒä»“é‡æ€»è®¡</div>
                    <div class="stat-value" id="totalPosition">-</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ğŸ”¥ ææ…Œæ¸…æ´—æŒ‡æ•°</div>
                    <div class="stat-value red" id="panicIndex">-</div>
                </div>
            </div>

            <button class="refresh-btn" onclick="refreshData()">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>

            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ ææ…Œæ¸…æ´—æŒ‡æ•°è¶‹åŠ¿ï¼ˆ24å°æ—¶ï¼‰</div>
                <canvas id="panicChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">ğŸ“Š çˆ†ä»“æ•°æ®è¶‹åŠ¿ï¼ˆ24å°æ—¶ï¼‰</div>
                <canvas id="liquidationChart"></canvas>
            </div>

            <div class="update-info">
                <p>æœ€åæ›´æ–°æ—¶é—´: <span id="updateTime">-</span></p>
                <p>è‡ªåŠ¨åˆ·æ–°é¢‘ç‡: æ¯30ç§’</p>
            </div>

            <!-- 30å¤©çˆ†ä»“æ—¥å† -->
            <div style="margin-top: 50px;">
                <h2 style="text-align: center; margin-bottom: 30px; color: #4a9eff;">ğŸ“… 30å¤©çˆ†ä»“æ•°æ®æ—¥å†</h2>
                
                <div style="overflow-x: auto; border-radius: 10px;">
                    <table id="calendar-table" style="width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.05);">
                        <thead>
                            <tr style="background: rgba(74, 158, 255, 0.2);">
                                <th style="padding: 15px; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.1); color: #fff;">æ—¥æœŸ</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.1); color: #ff4757;">å¤šå•çˆ†ä»“</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.1); color: #1dd1a1;">ç©ºå•çˆ†ä»“</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.1); color: #ffa502;">æ€»çˆ†ä»“</th>
                                <th style="padding: 15px; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.1); color: #fff;">è¶‹åŠ¿</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-tbody">
                            <tr>
                                <td colspan="5" style="padding: 30px; text-align: center; color: #888;">
                                    <div class="loading">ğŸ“Š åŠ è½½30å¤©æ•°æ®ä¸­...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 20px; text-align: center; color: #888; font-size: 12px;">
                    <p>ğŸ“Š æ•°æ®æ¥æº: <a href="https://history.btc123.fans/baocang/" target="_blank" style="color: #4a9eff; text-decoration: none;">BTC123 çˆ†ä»“æ•°æ®</a></p>
                    <p>ğŸ’¡ å¤šå•çˆ†ä»“ = åšå¤šè¢«å¼ºå¹³ï¼ˆä»·æ ¼ä¸‹è·Œï¼‰| ç©ºå•çˆ†ä»“ = åšç©ºè¢«å¼ºå¹³ï¼ˆä»·æ ¼ä¸Šæ¶¨ï¼‰</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let panicChart = null;
        let liquidationChart = null;

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num, decimals = 2) {
            if (num === null || num === undefined) return '-';
            return Number(num).toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        // æ ¼å¼åŒ–é‡‘é¢
        function formatAmount(amount) {
            if (amount >= 1e9) {
                return '$' + (amount / 1e9).toFixed(2) + 'B';
            } else if (amount >= 1e6) {
                return '$' + (amount / 1e6).toFixed(2) + 'M';
            } else {
                return '$' + formatNumber(amount, 0);
            }
        }

        // åŠ è½½æœ€æ–°æ•°æ®
        async function loadLatestData() {
            try {
                const response = await fetch('/api/panic-wash/latest');
                const result = await response.json();

                if (result.success && result.data) {
                    const data = result.data;
                    
                    document.getElementById('hour1Amount').textContent = formatAmount(data.hour_1_amount);
                    document.getElementById('hour24Amount').textContent = formatAmount(data.hour_24_amount);
                    document.getElementById('hour24People').textContent = formatNumber(data.hour_24_people, 0) + ' äºº';
                    document.getElementById('totalPosition').textContent = formatAmount(data.total_position);
                    document.getElementById('panicIndex').textContent = data.panic_index.toFixed(2) + '%';
                    document.getElementById('updateTime').textContent = data.record_time;

                    // æ˜¾ç¤ºå†…å®¹
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½å†å²æ•°æ®
        async function loadHistoryData() {
            try {
                const response = await fetch('/api/panic-wash/history');
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    updateCharts(result.data);
                }
            } catch (error) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts(data) {
            const labels = data.map(d => {
                const time = new Date(d.record_time);
                return time.getHours().toString().padStart(2, '0') + ':' + 
                       time.getMinutes().toString().padStart(2, '0');
            });

            // ææ…ŒæŒ‡æ•°å›¾è¡¨
            const panicData = data.map(d => d.panic_index.toFixed(2));
            
            if (panicChart) {
                panicChart.destroy();
            }

            const ctx1 = document.getElementById('panicChart').getContext('2d');
            panicChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ææ…Œæ¸…æ´—æŒ‡æ•° (%)',
                        data: panicData,
                        borderColor: '#ff4757',
                        backgroundColor: 'rgba(255, 71, 87, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#eee' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });

            // çˆ†ä»“æ•°æ®å›¾è¡¨
            const peopleData = data.map(d => d.hour_24_people);
            const positionData = data.map(d => d.total_position / 1e9); // è½¬æ¢ä¸ºåäº¿

            if (liquidationChart) {
                liquidationChart.destroy();
            }

            const ctx2 = document.getElementById('liquidationChart').getContext('2d');
            liquidationChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '24Hçˆ†ä»“äººæ•°',
                            data: peopleData,
                            borderColor: '#ffa502',
                            backgroundColor: 'rgba(255, 165, 2, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'å…¨ç½‘æŒä»“é‡ (B)',
                            data: positionData,
                            borderColor: '#4a9eff',
                            backgroundColor: 'rgba(74, 158, 255, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#eee' }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#ffa502' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#4a9eff' },
                            grid: { drawOnChartArea: false }
                        },
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        // æ‰‹åŠ¨åˆ·æ–°æ•°æ®
        async function refreshData() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';

            try {
                const response = await fetch('/api/panic-wash/refresh', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    await loadLatestData();
                    await loadHistoryData();
                    alert('âœ… æ•°æ®åˆ·æ–°æˆåŠŸï¼');
                } else {
                    alert('âŒ åˆ·æ–°å¤±è´¥: ' + (result.message || result.error));
                }
            } catch (error) {
                alert('âŒ åˆ·æ–°å¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ æ‰‹åŠ¨åˆ·æ–°';
            }
        }

        // åŠ è½½30å¤©çˆ†ä»“æ—¥å†æ•°æ®
        async function load30DayCalendar() {
            try {
                const response = await fetch('https://api.btc123.fans/bicoin.php?from=30daybaocang&t=' + Date.now());
                const result = await response.json();
                
                if (result.code === 0 && result.data && result.data.list) {
                    const tbody = document.getElementById('calendar-tbody');
                    tbody.innerHTML = '';
                    
                    const list = result.data.list;
                    
                    list.forEach((item, index) => {
                        const sellAmount = item.sellAmount || 0;  // å¤šå•çˆ†ä»“
                        const buyAmount = item.buyAmount || 0;    // ç©ºå•çˆ†ä»“
                        const totalAmount = sellAmount + buyAmount;
                        
                        // åˆ¤æ–­è¶‹åŠ¿ï¼ˆä¸å‰ä¸€å¤©æ¯”è¾ƒï¼‰
                        let trendIcon = 'â–';
                        let trendColor = '#888';
                        if (index < list.length - 1) {
                            const prevTotal = (list[index + 1].sellAmount || 0) + (list[index + 1].buyAmount || 0);
                            if (totalAmount > prevTotal * 1.1) {
                                trendIcon = 'ğŸ“ˆ';
                                trendColor = '#ff4757';
                            } else if (totalAmount < prevTotal * 0.9) {
                                trendIcon = 'ğŸ“‰';
                                trendColor = '#1dd1a1';
                            }
                        }
                        
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        row.style.transition = 'background 0.2s';
                        row.onmouseover = function() { this.style.background = 'rgba(255,255,255,0.05)'; };
                        row.onmouseout = function() { this.style.background = 'transparent'; };
                        
                        row.innerHTML = `
                            <td style="padding: 12px; color: #eee;">${item.dateStr}</td>
                            <td style="padding: 12px; text-align: right; color: #ff4757; font-family: monospace;">
                                ${formatAmount(sellAmount)}
                            </td>
                            <td style="padding: 12px; text-align: right; color: #1dd1a1; font-family: monospace;">
                                ${formatAmount(buyAmount)}
                            </td>
                            <td style="padding: 12px; text-align: right; color: #ffa502; font-weight: bold; font-family: monospace;">
                                ${formatAmount(totalAmount)}
                            </td>
                            <td style="padding: 12px; text-align: center; font-size: 20px; color: ${trendColor};">
                                ${trendIcon}
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    console.log('âœ… 30å¤©çˆ†ä»“æ—¥å†åŠ è½½æˆåŠŸ:', list.length, 'æ¡è®°å½•');
                } else {
                    console.error('âŒ 30å¤©æ•°æ®æ ¼å¼é”™è¯¯');
                    document.getElementById('calendar-tbody').innerHTML = `
                        <tr><td colspan="5" style="padding: 30px; text-align: center; color: #ff4757;">
                            âŒ æ•°æ®åŠ è½½å¤±è´¥
                        </td></tr>
                    `;
                }
            } catch (error) {
                console.error('âŒ åŠ è½½30å¤©æ—¥å†å¤±è´¥:', error);
                document.getElementById('calendar-tbody').innerHTML = `
                    <tr><td colspan="5" style="padding: 30px; text-align: center; color: #ff4757;">
                        âŒ åŠ è½½å¤±è´¥: ${error.message}
                    </td></tr>
                `;
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            await loadLatestData();
            await loadHistoryData();
            await load30DayCalendar();

            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(async () => {
                await loadLatestData();
                await loadHistoryData();
            }, 30000);
            
            // æ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡30å¤©æ—¥å†
            setInterval(async () => {
                await load30DayCalendar();
            }, 300000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
