# 自动采集系统使用说明

## 📋 功能概述

### 1. 10分钟自动采集守护进程
- ✅ 每10分钟自动采集一次数据
- ✅ 独立进程运行，不受网页刷新影响
- ✅ 自动记录日志
- ✅ 支持启动、停止、重启、状态查询

### 2. 批量导入当天数据
- ✅ 自动扫描当天所有txt文件
- ✅ 按时间从早到晚顺序导入
- ✅ 自动去重，跳过已导入文件
- ✅ 交互式确认

### 3. 时间轴排序
- ✅ 时间晚的在上面
- ✅ 时间早的在下面
- ✅ 最新数据在顶部

---

## 🚀 快速开始

### 启动自动采集

```bash
cd /home/user/webapp
./auto_collect_control.sh start
```

**输出示例**:
```
🚀 启动自动采集守护进程...
✅ 守护进程已启动 (PID: 12345)
📝 日志文件: /home/user/webapp/auto_collect.log
🔄 采集间隔: 10分钟
```

### 查看运行状态

```bash
./auto_collect_control.sh status
```

**输出示例**:
```
✅ 守护进程正在运行
   PID: 12345
   运行时间: 01:23:45
   日志文件: /home/user/webapp/auto_collect.log

📊 最近10条日志:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[2025-12-06 15:00:00] ✅ 数据采集成功
[2025-12-06 15:00:00]    快照ID: 5
[2025-12-06 15:00:00]    等级2: 1 个币种
[2025-12-06 15:10:00] ⏰ 距离下次采集还有: 9分0秒
```

### 查看日志

```bash
# 查看最近50条日志
./auto_collect_control.sh logs

# 实时查看日志（Ctrl+C 退出）
./auto_collect_control.sh logs -f
```

### 停止自动采集

```bash
./auto_collect_control.sh stop
```

**输出示例**:
```
🛑 停止守护进程 (PID: 12345)...
✅ 守护进程已停止
```

### 重启自动采集

```bash
./auto_collect_control.sh restart
```

---

## 📥 批量导入当天数据

### 使用方法

```bash
cd /home/user/webapp
python3 import_today_data.py
```

### 执行流程

1. **扫描文件**: 自动扫描 `temp_download` 目录下当天的所有txt文件
2. **排序**: 按时间从早到晚排序
3. **去重**: 检查哪些文件已导入，自动跳过
4. **确认**: 显示待导入文件列表，等待用户确认
5. **导入**: 逐个导入文件到数据库
6. **总结**: 显示导入成功/失败统计

### 示例输出

```
======================================================================
                    导入当天所有数据文件
======================================================================

📅 目标日期: 2025-12-06
✅ 找到 5 个文件

📂 文件列表（按时间从早到晚）:
   1. 2025-12-06_1000.txt (10:00)
   2. 2025-12-06_1010.txt (10:10)
   3. 2025-12-06_1020.txt (10:20)
   4. 2025-12-06_1030.txt (10:30)
   5. 2025-12-06_1040.txt (10:40)

🔍 检查导入状态...

✓ 已导入: 2 个文件
   ✓ 2025-12-06_1000.txt
   ✓ 2025-12-06_1010.txt

📥 需要导入: 3 个文件

是否继续导入？ (y/n): y

======================================================================
                        开始导入数据
======================================================================

[1/3] 导入: 2025-12-06_1020.txt ... ✅ 成功
[2/3] 导入: 2025-12-06_1030.txt ... ✅ 成功
[3/3] 导入: 2025-12-06_1040.txt ... ✅ 成功

======================================================================
                        导入完成
======================================================================

📊 导入统计:
   ✅ 成功: 3 个
   ❌ 失败: 0 个
   📁 总计: 3 个

✅ 数据已导入数据库，可以在Web界面查看
   时间轴顺序: 时间晚的在上，时间早的在下
```

---

## 📊 时间轴排序说明

### 新的排序方式（已修复）

**显示顺序**: 从上到下
```
1. 2025-12-06 14:54:34  ← 最新的（在上面）
2. 2025-12-06 14:48:48
3. 2025-12-06 13:42:42
4. 2025-12-05 14:27:33  ← 最早的（在下面）
```

**优点**:
- ✅ 最新数据在顶部，一眼就能看到
- ✅ 符合用户查看习惯
- ✅ 滚动查看历史数据更自然

---

## 🔧 技术细节

### 守护进程工作原理

1. **独立进程**: 作为后台进程运行，PID保存在 `auto_collect.pid`
2. **定时循环**: 每10分钟执行一次 `collect_and_store.py`
3. **日志记录**: 所有操作记录到 `auto_collect.log`
4. **信号处理**: 捕获 SIGTERM 和 SIGINT，优雅退出
5. **错误恢复**: 出错后等待10秒继续运行

### 文件位置

| 文件 | 路径 | 说明 |
|------|------|------|
| 守护进程 | `auto_collect_daemon.py` | 主程序 |
| 管理脚本 | `auto_collect_control.sh` | 启动/停止脚本 |
| 导入脚本 | `import_today_data.py` | 批量导入工具 |
| 日志文件 | `auto_collect.log` | 运行日志 |
| PID文件 | `auto_collect.pid` | 进程ID |

### 数据库排序

```sql
-- 时间轴API查询（倒序）
SELECT * FROM crypto_snapshots
ORDER BY snapshot_time DESC;  -- 从新到旧
```

---

## ⚠️ 注意事项

### 1. 守护进程管理

- ✅ **启动前检查**: 确保没有重复运行
- ✅ **停止进程**: 使用 `./auto_collect_control.sh stop`，不要直接 `kill -9`
- ✅ **查看日志**: 定期检查 `auto_collect.log`

### 2. 数据导入

- ✅ **避免重复**: 脚本会自动检查并跳过已导入文件
- ✅ **顺序导入**: 文件按时间从早到晚导入
- ✅ **确认操作**: 导入前会显示列表并要求确认

### 3. 时间轴显示

- ✅ **刷新页面**: 导入新数据后刷新Web界面
- ✅ **排序正确**: 最新数据在顶部
- ✅ **自动更新**: 守护进程采集的数据会自动出现

---

## 🐛 故障排查

### 问题1: 守护进程无法启动

**可能原因**:
- 端口被占用
- 采集脚本不存在
- 权限不足

**解决方法**:
```bash
# 检查采集脚本
ls -la /home/user/webapp/collect_and_store.py

# 查看日志
tail -50 /home/user/webapp/auto_collect.log

# 手动执行一次采集测试
python3 /home/user/webapp/collect_and_store.py
```

### 问题2: 数据采集失败

**可能原因**:
- 网络问题
- Google Drive访问受限
- 文件格式错误

**解决方法**:
```bash
# 查看详细日志
./auto_collect_control.sh logs -f

# 手动测试采集
python3 /home/user/webapp/collect_and_store.py
```

### 问题3: 时间轴顺序错误

**解决方法**:
```bash
# 检查数据库排序
python3 -c "
import sqlite3
conn = sqlite3.connect('crypto_data.db')
cursor = conn.cursor()
cursor.execute('SELECT snapshot_time FROM crypto_snapshots ORDER BY snapshot_time DESC LIMIT 5')
for row in cursor.fetchall():
    print(row[0])
conn.close()
"

# 重启Flask服务
pkill -f app_new.py
python3 app_new.py &
```

---

## 📞 支持

遇到问题？查看:
- 📝 日志文件: `/home/user/webapp/auto_collect.log`
- 🐛 GitHub Issues: https://github.com/jamesyidc/6666/issues
- 📚 主README: `/home/user/webapp/README.md`

---

**✅ 自动采集系统已就绪！每10分钟自动更新数据！**
