# 📊 v6.0 版本更新 - 差值曲线完整实现

## 🎯 更新时间
**2025年12月2日**

---

## ✨ 核心更新

### 1. **差值曲线图完整实现**
   - ✅ 在趋势图中新增"差值(急涨-急跌)"曲线
   - ✅ 差值使用独立的第二Y轴（右侧）
   - ✅ 蓝色曲线显示，橙色高亮标记
   - ✅ 自动计算并显示 `差值 = 急涨 - 急跌`

### 2. **智能高亮标记系统**
   根据用户要求，以下条件会触发数据点高亮显示：

   | 指标 | 高亮条件 | 颜色 | 大小 |
   |------|---------|------|------|
   | **急涨** | ≥ 10 | 亮绿色 #00ff00 | 10px |
   | **急跌** | ≥ 10 | 亮红色 #ff0000 | 10px |
   | **差值** | ≥ 50 或 ≤ -50 | 橙色 #ff6600 | 10px |

   - **未达标点**: 使用半透明颜色，4px大小
   - **高亮点**: 使用明亮颜色，10px大小

### 3. **精确的时间戳机制**
   ✅ **更新时间 = TXT文件时间戳 + 1分钟**
   
   - 后端返回 `fileTimestamp` (TXT文件时间)
   - 前端计算 `更新时间 = fileTimestamp + 1分钟`
   - 图表X轴使用精确的更新时间（非刷新时间）
   - 倒计时基于文件时间+1分钟计算

   **示例**:
   ```
   TXT文件时间: 2025-12-02 18:06:00
   更新时间:    2025-12-02 18:07:00  ← 显示在图表
   下次更新:    2025-12-02 18:17:00  ← 10分钟后
   ```

---

## 🎨 视觉效果

### 图表说明
```
📊 急涨急跌趋势统计

左Y轴 (急涨/急跌数量)     右Y轴 (差值)
        |                        |
    25 -|                        |- 50
        |    ●●●                 |
    20 -|   ●   ●                |- 40
        |  ●     ●    ◆          |
    15 -| ●       ●  ● ●         |- 30
        |          ● ●   ●       |
    10 -|         ●       ●      |- 20
        |        ●         ●     |
     5 -|       ●           ●    |- 10
        |________________________________
         08:00  10:00  12:00  14:00

绿线 = 急涨    红线 = 急跌    蓝线 = 差值

● 大点 = 高亮 (急涨≥10, 急跌≥10)
◆ 大橙点 = 差值高亮 (≥50或≤-50)
```

---

## 🔧 技术实现

### 后端改进 (`crypto_server_demo.py`)
```python
# 返回明确的文件时间戳
return jsonify({
    'updateTime': file_time_str,      # 文件时间
    'fileTimestamp': file_time_str     # 明确字段名
})
```

### 前端改进 (`crypto_dashboard.html`)

#### 1. 差值计算
```javascript
const rushUp = parseInt(stats.rushUp) || 0;
const rushDown = parseInt(stats.rushDown) || 0;
const diff = rushUp - rushDown;  // 自动计算差值
```

#### 2. 高亮逻辑
```javascript
// 急涨高亮: ≥10
if (rushUp >= 10) {
    color = '#00ff00';  // 亮绿
    size = 10;
}

// 急跌高亮: ≥10
if (rushDown >= 10) {
    color = '#ff0000';  // 亮红
    size = 10;
}

// 差值高亮: ≥50 或 ≤-50
if (diff >= 50 || diff <= -50) {
    color = '#ff6600';  // 橙色
    size = 10;
}
```

#### 3. 时间戳处理
```javascript
// 文件时间 + 1分钟 = 更新时间
const fileDate = new Date(fileTime);
fileDate.setMinutes(fileDate.getMinutes() + 1);
const updateTime = fileDate;

// 下次更新 = 更新时间 + 10分钟
const nextUpdate = new Date(updateTime.getTime() + 10 * 60 * 1000);
```

---

## 📋 完整功能清单

### ✅ 已实现功能
- [x] 29个加密货币实时监控
- [x] 急涨/急跌数据统计
- [x] 差值曲线图
- [x] 双Y轴图表（左侧：急涨急跌，右侧：差值）
- [x] 智能高亮标记（急涨≥10, 急跌≥10, 差值≥50/≤-50）
- [x] 基于TXT文件时间戳的更新机制（文件时间+1分钟）
- [x] 10分钟自动刷新
- [x] 历史数据完整加载（当天所有TXT文件）
- [x] 去重逻辑（相同时间点不重复添加）
- [x] 响应式倒计时（基于文件时间精确计算）
- [x] 数据表格完整展示（序号、币名、涨跌幅等17列）
- [x] 颜色识别（绿/红/黄单元格）

### 🎯 关键特性
1. **完全自动化**: 无需人工干预，自动读取Google Drive
2. **精确时间**: 基于文件时间戳，而非客户端时间
3. **视觉高亮**: 关键数据点自动放大和着色
4. **历史追溯**: 保留当天所有数据点（最多50个）
5. **实时更新**: 每10分钟自动刷新，倒计时提示

---

## 🚀 使用说明

### 1. 启动演示服务器
```bash
cd /home/user/webapp
python3 crypto_server_demo.py
```

### 2. 访问页面
```
https://5001-<sandbox-id>.sandbox.novita.ai/?v=6
```

### 3. 观察高亮
- **绿色大点**: 急涨 ≥ 10
- **红色大点**: 急跌 ≥ 10
- **橙色大点**: 差值 ≥ 50 或 ≤ -50
- **小点**: 正常数据（未达到高亮条件）

### 4. 验证时间戳
打开浏览器控制台 (F12)，查看日志：
```
文件时间: 2025-12-02 18:06:00
更新时间(+1分钟): 18:07
下次更新: 18:17
剩余秒数: 598
```

---

## 📊 数据流程

```
┌─────────────────────┐
│  Google Drive       │
│  2025-12-02/        │
│  ├─ 0830.txt        │
│  ├─ 0840.txt        │
│  └─ 1806.txt ←最新  │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  后端服务器          │
│  crypto_server.py   │
│  - 读取所有TXT       │
│  - 解析急涨急跌      │
│  - 提取文件时间戳    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  前端页面            │
│  crypto_dashboard   │
│  - 加载历史数据      │
│  - 计算差值         │
│  - 标记高亮点       │
│  - 文件时间+1分钟   │
└──────────┬──────────┘
           │
           ▼
     📈 实时图表展示
```

---

## 🔍 测试验证

### 测试场景 1: 高亮标记
1. 查看图表，找到大点（10px）
2. 悬停查看数值：
   - 急涨 ≥ 10？✓
   - 急跌 ≥ 10？✓
   - 差值 ≥ 50？✓

### 测试场景 2: 时间戳
1. 打开浏览器控制台
2. 查看日志输出的文件时间
3. 验证图表X轴时间 = 文件时间 + 1分钟

### 测试场景 3: 差值计算
1. 记录某个时间点的急涨和急跌
2. 计算: 差值 = 急涨 - 急跌
3. 对比图表中差值曲线的数值

---

## 📝 注意事项

1. **演示模式**
   - 当前运行的是 `crypto_server_demo.py`
   - 使用模拟数据，方便测试
   - 要使用真实数据，运行 `python3 crypto_server.py`

2. **Google Drive配置**
   - 真实模式需要 `credentials.json`
   - 参考 `USAGE_CN.md` 配置API

3. **浏览器缓存**
   - 使用 `?v=6` URL参数强制刷新
   - 或使用 Ctrl+F5 / Cmd+Shift+R

4. **数据限制**
   - 最多保留50个历史数据点
   - 超过后自动删除最旧数据

---

## 🎉 版本总结

**v6.0** 是一个完整的、功能齐全的加密货币监控系统：

✅ **数据完整**: 29个币种，17列信息  
✅ **图表丰富**: 三条曲线（急涨、急跌、差值），双Y轴  
✅ **高亮智能**: 自动标记关键数据点  
✅ **时间精确**: 基于文件时间戳+1分钟  
✅ **自动化**: 10分钟刷新，无需人工操作  
✅ **历史数据**: 当天所有数据完整展示  

---

## 📞 问题反馈

如有任何问题或建议，请查看：
- `README.md` - 项目概述
- `USAGE_CN.md` - 详细使用指南
- `QUICK_REFERENCE.md` - 快速参考

---

**更新完成！系统已就绪！** 🎊
