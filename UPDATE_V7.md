# 📊 v7.0 版本更新 - 累加数据&计次曲线

## 🎯 更新时间
**2025年12月2日**

---

## ✨ 核心更新

### 1. **修正数据理解 - 累加特性**
   ✅ **重要修正**: 急涨、急跌、计次都是**累加的**
   - TXT文件中记录的是**累计值**，不是增量
   - 后面的数字**永远 ≥ 前面的数字**（单调递增）
   - 前端**直接显示TXT文件中的数字**，不需要计算

   **错误理解** ❌:
   ```
   08:00 急涨=8   (每次单独计算)
   08:10 急涨=10  (每次单独计算)
   08:20 急涨=7   (可能下降) ← 这是错的！
   ```

   **正确理解** ✅:
   ```
   08:00 急涨=8   (累计值)
   08:10 急涨=18  (累计值，18 ≥ 8)
   08:20 急涨=23  (累计值，23 ≥ 18)
   ```

### 2. **新增计次曲线**
   ✅ 在趋势图中新增第四条曲线："计次"
   - 紫色曲线 (#ff00ff)
   - 使用右Y轴（与差值共用）
   - 同样是累加的数据

   **曲线列表**:
   1. 🟢 急涨（绿线，左Y轴）
   2. 🔴 急跌（红线，左Y轴）
   3. 🔵 差值（蓝线，右Y轴）
   4. 🟣 计次（紫线，右Y轴）← 新增

### 3. **数据验证机制**
   ✅ 后端自动验证累加特性
   - 检查每个数据点是否 ≥ 前一个数据点
   - 发现异常时输出警告日志
   - 确保数据的正确性

---

## 🔧 技术实现

### 后端改进 (`crypto_server_demo.py`)

#### 数据生成逻辑
```python
# 模拟TXT文件中的累加值（只增不减）
cumulative_rush_up = 0
cumulative_rush_down = 0
cumulative_count = 0

for each_time_point:
    # 累加增量
    cumulative_rush_up += random.randint(0, 3)
    cumulative_rush_down += random.randint(0, 2)
    if random.random() < 0.3:
        cumulative_count += 1
    
    # 保存累计值（TXT文件中的数字）
    history.append({
        'rushUp': str(cumulative_rush_up),
        'rushDown': str(cumulative_rush_down),
        'count': str(cumulative_count)
    })
```

#### 数据验证逻辑
```python
# 验证累加特性
for i in range(1, len(history)):
    prev_up = int(history[i-1]['rushUp'])
    curr_up = int(history[i]['rushUp'])
    
    # 检查是否违反累加规则
    if curr_up < prev_up:
        print(f"⚠️  警告: 急涨数据异常")
```

### 前端改进 (`crypto_dashboard.html`)

#### 历史数据结构
```javascript
let historyData = {
    timestamps: [],
    rushUp: [],     // TXT文件中的累计值
    rushDown: [],   // TXT文件中的累计值
    diff: [],       // 前端计算的差值
    count: []       // TXT文件中的累计值（新增）
};
```

#### 图表配置
```javascript
datasets: [
    { label: '急涨', yAxisID: 'y' },
    { label: '急跌', yAxisID: 'y' },
    { label: '差值(急涨-急跌)', yAxisID: 'y1' },
    { label: '计次', yAxisID: 'y1', borderColor: '#ff00ff' }  // 新增
]
```

---

## 📊 数据示例

### 正确的累加数据
```
时间    急涨  急跌  计次  差值
08:00    2     1     1     1
08:10    4     2     1     2
08:20    5     2     2     3
08:30    8     3     2     5
08:40    10    4     3     6
08:50    13    6     3     7
...
18:50    99    65    20    34
19:00    101   65    21    36
```

**验证**:
- ✅ 急涨: 2 → 4 → 5 → 8 → 10 → 13 → ... → 99 → 101 (单调递增)
- ✅ 急跌: 1 → 2 → 2 → 3 → 4 → 6 → ... → 65 → 65 (单调递增)
- ✅ 计次: 1 → 1 → 2 → 2 → 3 → 3 → ... → 20 → 21 (单调递增)

---

## 🎨 视觉效果

### 图表显示
```
急涨急跌趋势统计

左Y轴 (急涨/急跌)              右Y轴 (差值/计次)
    |                              |
100-|     ●●●●●●                   |- 40
    |   ●●        急涨              |
 80-|  ●                            |- 30
    | ●                             |
 60-|●           ●●●●  急跌         |- 20  ◆◆◆  计次
    |          ●●                   |       ◆◆
 40-|         ●                     |- 10  ◆
    |        ●                      |     ◆
 20-|       ●                       |- 0  ◆
    |_______________________________ |
     08:00  10:00  12:00  14:00

🟢 急涨 (绿线，左Y轴)
🔴 急跌 (红线，左Y轴)
🔵 差值 (蓝线，右Y轴)
🟣 计次 (紫线，右Y轴)
```

---

## 🔍 关键变更说明

### 1. 数据来源
**v6.0** ❌:
- 每个时间点独立计算急涨急跌
- 可能出现下降的情况

**v7.0** ✅:
- 直接使用TXT文件中的累计值
- 确保单调递增

### 2. 曲线数量
**v6.0**:
- 3条曲线（急涨、急跌、差值）

**v7.0**:
- 4条曲线（急涨、急跌、差值、计次）

### 3. Y轴配置
**左Y轴**: 急涨/急跌数量  
**右Y轴**: 差值 / 计次

---

## 📝 使用说明

### 查看累加数据
1. 访问页面
2. 观察图表中的曲线
3. 所有曲线应该是**向上或水平**的，不会向下

### 验证数据正确性
```bash
# 运行测试脚本
python3 test_v7_features.py

# 检查输出
✅ 急涨: 2 → 101 (单调递增: ✓)
✅ 急跌: 1 → 65 (单调递增: ✓)
✅ 计次: 1 → 21 (单调递增: ✓)
🎉 所有数据都正确实现累加特性！
```

---

## ⚠️ 重要提醒

### 对于真实数据（crypto_server.py）
在真实模式下，系统会：
1. 读取Google Drive中的TXT文件
2. 直接提取文件中的急涨、急跌、计次数字
3. 这些数字应该已经是累计值
4. 如果发现后面的数字小于前面的，会输出警告

### TXT文件格式要求
```
急涨总和=急涨：15
急跌总和=急跌：4
计次：7
```

系统会提取：
- `急涨: 15` (累计值)
- `急跌: 4` (累计值)
- `计次: 7` (累计值)

---

## 🚀 启动服务

```bash
# 演示版本
cd /home/user/webapp
python3 crypto_server_demo.py

# 真实版本
python3 crypto_server.py
```

### 访问地址
```
https://5001-<sandbox-id>.sandbox.novita.ai/?v=7
```

---

## 📊 测试结果

```
✅ v7.0 历史数据API正常
数据点数量: 68

📊 前3个数据点:
  08:00: 急涨=2, 急跌=1, 计次=1
  08:10: 急涨=4, 急跌=2, 计次=1
  08:20: 急涨=5, 急跌=2, 计次=2

📊 后3个数据点:
  18:50: 急涨=99, 急跌=65, 计次=20
  19:00: 急涨=101, 急跌=65, 计次=21
  19:10: 急涨=101, 急跌=65, 计次=21

✅ 累加验证:
急涨: 2 → 101 (单调递增: ✓)
急跌: 1 → 65 (单调递增: ✓)
计次: 1 → 21 (单调递增: ✓)

🎉 所有数据都正确实现累加特性！
```

---

## 🎉 版本总结

**v7.0** 修正了对数据的理解，并添加了计次曲线：

✅ **数据正确性**: 急涨/急跌/计次都是累加的，直接显示TXT文件中的数字  
✅ **新增曲线**: 添加了计次曲线（紫色，右Y轴）  
✅ **数据验证**: 后端自动验证累加特性  
✅ **视觉优化**: 4条曲线清晰展示所有数据  

**系统已修正并优化，可以正确显示累加数据！** 🚀
