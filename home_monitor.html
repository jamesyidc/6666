<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–é¡µæ•°æ®ç›‘æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .update-info {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-value.up {
            color: #28a745;
        }

        .stat-value.down {
            color: #dc3545;
        }

        .stat-value.neutral {
            color: #6c757d;
        }

        .table-container {
            padding: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #f1f3f5;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .positive {
            color: #28a745;
            font-weight: 600;
        }

        .negative {
            color: #dc3545;
            font-weight: 600;
        }

        .rush-up {
            background: #d4edda;
            color: #155724;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .rush-down {
            background: #f8d7da;
            color: #721c24;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }

        .refresh-timer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 25px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .manual-update {
            margin: 20px;
            padding: 20px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
        }

        .manual-update h3 {
            margin-bottom: 10px;
            color: #856404;
        }

        .manual-update textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .manual-update button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .manual-update button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š é¦–é¡µæ•°æ®ç›‘æ§</h1>
            <div class="update-info">
                <div>æ›´æ–°æ—¶é—´: <span id="updateTime">--</span></div>
                <div>æ•°æ®æ¥æº: Google Drive å…¬å¼€æ–‡ä»¶å¤¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰</div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-label">ğŸŸ¢ æ€¥æ¶¨æ€»å’Œ</div>
                <div class="stat-value up" id="rushUp">--</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ğŸ”´ æ€¥è·Œæ€»å’Œ</div>
                <div class="stat-value down" id="rushDown">--</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ğŸ“Š å¸‚åœºçŠ¶æ€</div>
                <div class="stat-value neutral" id="status">--</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ğŸ’¹ æ¯”å€¼</div>
                <div class="stat-value neutral" id="ratio">--</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ğŸ“ˆ å¸ç§æ•°é‡</div>
                <div class="stat-value neutral" id="coinCount">--</div>
            </div>
        </div>

        <!-- æ‰‹åŠ¨æ›´æ–°åŒºåŸŸ -->
        <div class="manual-update" id="manualUpdateSection" style="display:none;">
            <h3>ğŸ“ æ‰‹åŠ¨æ›´æ–°æ•°æ®</h3>
            <p>å°†æœ€æ–°çš„ TXT æ–‡ä»¶å†…å®¹ç²˜è´´åˆ°ä¸‹æ–¹ï¼Œç„¶åç‚¹å‡»æ›´æ–°ï¼š</p>
            <textarea id="dataInput" placeholder="ç²˜è´´ TXT æ–‡ä»¶å†…å®¹..."></textarea>
            <button onclick="manualUpdate()">ğŸ”„ æ›´æ–°æ•°æ®</button>
            <span id="updateStatus"></span>
        </div>

        <div class="table-container">
            <div id="loading" class="loading">
                <div>â³ æ­£åœ¨åŠ è½½æ•°æ®...</div>
            </div>
            <div id="error" class="error" style="display:none;"></div>
            <table id="dataTable" style="display:none;">
                <thead>
                    <tr>
                        <th>åºå·</th>
                        <th>å¸å</th>
                        <th>æ¶¨å¹…%</th>
                        <th>æ€¥æ¶¨</th>
                        <th>æ€¥è·Œ</th>
                        <th>æ›´æ–°æ—¶é—´</th>
                        <th>å†å²é«˜ä»·</th>
                        <th>é«˜ä»·æ—¶é—´</th>
                        <th>è·Œå¹…%</th>
                        <th>24hæ¶¨å¹…%</th>
                        <th>æ’å</th>
                        <th>å½“å‰ä»·æ ¼</th>
                        <th>æ¯”ç‡1</th>
                        <th>æ¯”ç‡2</th>
                    </tr>
                </thead>
                <tbody id="dataBody">
                </tbody>
            </table>
        </div>
    </div>

    <div class="refresh-timer">
        â° ä¸‹æ¬¡åˆ·æ–°: <span id="countdown">--</span>
    </div>

    <script>
        const REFRESH_INTERVAL = 10 * 60 * 1000; // 10åˆ†é’Ÿ
        let countdownInterval;
        let refreshTimeout;
        let lastRefreshTime = 0;

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/home-data?_t=${timestamp}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'æ•°æ®åŠ è½½å¤±è´¥');
                }
                
                // æ˜¾ç¤ºæ•°æ®
                displayData(result);
                
                // éšè—åŠ è½½/é”™è¯¯æç¤º
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
                
                // è®°å½•åˆ·æ–°æ—¶é—´
                lastRefreshTime = Date.now();
                
                // å¼€å§‹å€’è®¡æ—¶
                startCountdown();
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    âŒ åŠ è½½å¤±è´¥: ${error.message}<br>
                    <small>è¯·æ£€æŸ¥æ•°æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæˆ–å°è¯•æ‰‹åŠ¨æ›´æ–°</small>
                `;
                
                // æ˜¾ç¤ºæ‰‹åŠ¨æ›´æ–°åŒºåŸŸ
                document.getElementById('manualUpdateSection').style.display = 'block';
            }
        }

        // æ˜¾ç¤ºæ•°æ®
        function displayData(result) {
            const { data, stats, updateTime, dataCount } = result;
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('updateTime').textContent = updateTime || '--';
            document.getElementById('rushUp').textContent = stats.rushUp || 0;
            document.getElementById('rushDown').textContent = stats.rushDown || 0;
            document.getElementById('status').textContent = stats.status || '--';
            document.getElementById('ratio').textContent = stats.ratio || '--';
            document.getElementById('coinCount').textContent = dataCount || 0;
            
            // æ›´æ–°è¡¨æ ¼
            const tbody = document.getElementById('dataBody');
            tbody.innerHTML = '';
            
            data.forEach(coin => {
                const row = document.createElement('tr');
                
                // æ ¼å¼åŒ–æ¶¨è·Œå¹…
                const change = parseFloat(coin.change || 0);
                const change24h = parseFloat(coin.change24h || 0);
                const decline = parseFloat(coin.decline || 0);
                
                row.innerHTML = `
                    <td>${coin.index}</td>
                    <td><strong>${coin.symbol}</strong></td>
                    <td class="${change >= 0 ? 'positive' : 'negative'}">${change > 0 ? '+' : ''}${change}</td>
                    <td>${coin.rushUp > 0 ? `<span class="rush-up">${coin.rushUp}</span>` : coin.rushUp}</td>
                    <td>${coin.rushDown > 0 ? `<span class="rush-down">${coin.rushDown}</span>` : coin.rushDown}</td>
                    <td>${coin.updateTime}</td>
                    <td>${coin.highPrice}</td>
                    <td>${coin.highTime}</td>
                    <td class="${decline >= 0 ? 'positive' : 'negative'}">${decline}</td>
                    <td class="${change24h >= 0 ? 'positive' : 'negative'}">${change24h > 0 ? '+' : ''}${change24h}</td>
                    <td>${coin.rank || '--'}</td>
                    <td>${coin.currentPrice || '--'}</td>
                    <td>${coin.ratio1 || '--'}</td>
                    <td>${coin.ratio2 || '--'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // å€’è®¡æ—¶
        function startCountdown() {
            // æ¸…é™¤æ—§çš„å€’è®¡æ—¶
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            if (refreshTimeout) {
                clearTimeout(refreshTimeout);
            }
            
            const countdownElement = document.getElementById('countdown');
            const targetTime = lastRefreshTime + REFRESH_INTERVAL;
            
            countdownInterval = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, targetTime - now);
                
                if (remaining === 0) {
                    clearInterval(countdownInterval);
                    countdownElement.textContent = 'æ­£åœ¨åˆ·æ–°...';
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                countdownElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
            
            // è®¾ç½®ä¸‹æ¬¡åˆ·æ–°
            refreshTimeout = setTimeout(() => {
                loadData();
            }, REFRESH_INTERVAL);
        }

        // æ‰‹åŠ¨æ›´æ–°
        async function manualUpdate() {
            const dataInput = document.getElementById('dataInput');
            const statusSpan = document.getElementById('updateStatus');
            const content = dataInput.value.trim();
            
            if (!content) {
                statusSpan.textContent = 'âŒ è¯·è¾“å…¥æ•°æ®';
                statusSpan.style.color = 'red';
                return;
            }
            
            try {
                statusSpan.textContent = 'â³ æ­£åœ¨æ›´æ–°...';
                statusSpan.style.color = '#007bff';
                
                const response = await fetch('/api/update-home-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusSpan.textContent = 'âœ… æ›´æ–°æˆåŠŸï¼';
                    statusSpan.style.color = 'green';
                    dataInput.value = '';
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    setTimeout(() => {
                        loadData();
                        document.getElementById('manualUpdateSection').style.display = 'none';
                    }, 1000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                statusSpan.textContent = `âŒ æ›´æ–°å¤±è´¥: ${error.message}`;
                statusSpan.style.color = 'red';
            }
        }

        // é¡µé¢åŠ è½½æ—¶
        window.addEventListener('load', () => {
            loadData();
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶é‡æ–°åŠ è½½
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // å¦‚æœè·ç¦»ä¸Šæ¬¡åˆ·æ–°è¶…è¿‡10åˆ†é’Ÿï¼Œç«‹å³åˆ·æ–°
                if (Date.now() - lastRefreshTime > REFRESH_INTERVAL) {
                    loadData();
                }
            }
        });
    </script>
</body>
</html>
