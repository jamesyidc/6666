# 📐 加密货币得分系统 - 系统架构

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    加密货币得分系统 V1.0                          │
│                  Cryptocurrency Score System                     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        用户访问层                                 │
├─────────────────────────────────────────────────────────────────┤
│  Web浏览器              API客户端              测试脚本           │
│     │                      │                      │               │
│     └──────────┬───────────┴──────────────────────┘               │
│                │                                                  │
│             HTTPS/HTTP                                           │
└─────────────────┼─────────────────────────────────────────────────┘
                 │
┌────────────────▼──────────────────────────────────────────────┐
│                        Web服务层                               │
│                     (Flask Server)                             │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────────────┐    ┌──────────────────┐                  │
│  │   静态文件服务  │    │   API路由管理     │                  │
│  │  Static Files  │    │   API Routes      │                  │
│  └────────────────┘    └──────────────────┘                  │
│                                                                 │
│  Routes:                                                        │
│  • GET  /                → Web界面                             │
│  • GET  /api/score/statistics  → 统计数据                     │
│  • GET  /api/score/coins       → 币种详情                     │
│  • GET  /api/score/refresh     → 手动刷新                     │
│                                                                 │
└────────────────┬────────────────────────────────────────────────┘
                │
┌───────────────▼──────────────────────────────────────────────┐
│                      业务逻辑层                                │
│                   (Business Logic)                             │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐    │
│  │         ScoreCollector (数据采集器)                   │    │
│  ├──────────────────────────────────────────────────────┤    │
│  │ • 币种管理 (19个加密货币)                             │    │
│  │ • 时间范围管理 (3m/1h/3h/6h/12h/24h)                 │    │
│  │ • 得分数据生成                                        │    │
│  │ • 统计计算逻辑                                        │    │
│  └───────────────────┬──────────────────────────────────┘    │
│                      │                                         │
│  ┌──────────────────▼──────────────────────────────────┐    │
│  │         ScoreDatabase (数据库管理器)                  │    │
│  ├──────────────────────────────────────────────────────┤    │
│  │ • 数据库连接管理                                      │    │
│  │ • 表结构初始化                                        │    │
│  │ • CRUD操作封装                                        │    │
│  │ • 查询优化                                            │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                                 │
└────────────────┬────────────────────────────────────────────────┘
                │
┌───────────────▼──────────────────────────────────────────────┐
│                       数据存储层                                │
│                    (Data Storage)                              │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐    │
│  │           SQLite Database (crypto_data.db)            │    │
│  ├──────────────────────────────────────────────────────┤    │
│  │                                                        │    │
│  │  📊 score_history (得分历史记录)                      │    │
│  │  ┌─────────────────────────────────────────────┐    │    │
│  │  │ • id (主键)                                  │    │    │
│  │  │ • symbol (币种符号)                         │    │    │
│  │  │ • time_range (时间范围)                     │    │    │
│  │  │ • long_score (做多得分)                     │    │    │
│  │  │ • short_score (做空得分)                    │    │    │
│  │  │ • score_diff (得分差值)                     │    │    │
│  │  │ • data_source (数据来源)                    │    │    │
│  │  │ • record_time (记录时间)                    │    │    │
│  │  └─────────────────────────────────────────────┘    │    │
│  │                                                        │    │
│  │  📈 score_statistics (统计数据)                       │    │
│  │  ┌─────────────────────────────────────────────┐    │    │
│  │  │ • id (主键)                                  │    │    │
│  │  │ • time_range (时间范围)                     │    │    │
│  │  │ • avg_long_score (平均做多得分)             │    │    │
│  │  │ • avg_short_score (平均做空得分)            │    │    │
│  │  │ • avg_diff (平均差值)                       │    │    │
│  │  │ • coin_count (币种数量)                     │    │    │
│  │  │ • update_time (更新时间)                    │    │    │
│  │  └─────────────────────────────────────────────┘    │    │
│  │                                                        │    │
│  │  📑 Indexes:                                           │    │
│  │    • idx_score_history_time                           │    │
│  │    • idx_score_history_symbol                         │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      后台任务层                                   │
│                   (Background Tasks)                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────┐      │
│  │         Auto Update Thread (自动更新线程)             │      │
│  ├──────────────────────────────────────────────────────┤      │
│  │                                                        │      │
│  │  ⏰ 触发频率: 每3分钟 (180秒)                         │      │
│  │                                                        │      │
│  │  🔄 执行流程:                                          │      │
│  │    1. 采集所有币种所有时间范围的得分                  │      │
│  │    2. 计算各时间范围的统计指标                        │      │
│  │    3. 保存到数据库                                    │      │
│  │    4. 记录日志                                        │      │
│  │                                                        │      │
│  │  ✅ 守护线程: 随主进程启动和退出                      │      │
│  │  ✅ 异常处理: 自动捕获并记录错误                      │      │
│  │                                                        │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 数据流程图

### 数据采集流程

```
开始
 │
 ├─> 遍历19个币种
 │    │
 │    ├─> 遍历6个时间范围 (3m, 1h, 3h, 6h, 12h, 24h)
 │    │    │
 │    │    ├─> 生成/获取 做多得分
 │    │    ├─> 生成/获取 做空得分
 │    │    ├─> 计算差值 = 做多得分 - 做空得分
 │    │    │
 │    │    └─> 保存到 score_history 表
 │    │
 │    └─> 下一个币种
 │
 ├─> 计算统计数据
 │    │
 │    ├─> 对每个时间范围
 │    │    │
 │    │    ├─> 计算平均做多得分
 │    │    ├─> 计算平均做空得分
 │    │    ├─> 计算平均差值
 │    │    ├─> 统计币种数量
 │    │    │
 │    │    └─> 保存到 score_statistics 表
 │    │
 │    └─> 下一个时间范围
 │
 └─> 完成
```

### API请求流程

```
客户端请求
    │
    ├─> GET /api/score/statistics
    │    │
    │    ├─> 查询 score_statistics 表
    │    ├─> 获取最新一批统计数据
    │    ├─> 按时间范围排序
    │    ├─> 格式化为 JSON
    │    └─> 返回客户端
    │
    ├─> GET /api/score/coins
    │    │
    │    ├─> 查询 score_history 表
    │    ├─> 过滤指定时间范围内的数据
    │    ├─> 按币种分组
    │    ├─> 按时间范围组织
    │    ├─> 格式化为 JSON
    │    └─> 返回客户端
    │
    └─> GET /api/score/refresh
         │
         ├─> 触发即时数据采集
         ├─> 执行统计计算
         ├─> 更新数据库
         ├─> 返回成功状态
         └─> 返回客户端
```

---

## 🖥️ 前端架构

```
┌─────────────────────────────────────────────────────────────┐
│                    score_system.html                         │
│                    (Single Page Application)                 │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌────────────────────────────────────────────────────┐    │
│  │              Header Section                         │    │
│  │  • 系统标题                                         │    │
│  │  • 更新时间显示                                     │    │
│  │  • 手动刷新按钮                                     │    │
│  └────────────────────────────────────────────────────┘    │
│                                                               │
│  ┌────────────────────────────────────────────────────┐    │
│  │         Statistics Panel (统计面板)                │    │
│  │                                                      │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐           │    │
│  │  │ 3分钟卡片 │ │ 1小时卡片 │ │ 3小时卡片 │           │    │
│  │  │ • 做多   │ │ • 做多   │ │ • 做多   │           │    │
│  │  │ • 做空   │ │ • 做空   │ │ • 做空   │           │    │
│  │  │ • 差值   │ │ • 差值   │ │ • 差值   │           │    │
│  │  │ • 趋势   │ │ • 趋势   │ │ • 趋势   │           │    │
│  │  └──────────┘ └──────────┘ └──────────┘           │    │
│  │                                                      │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐           │    │
│  │  │ 6小时卡片 │ │ 12小时卡片│ │ 24小时卡片│           │    │
│  │  │   ...    │ │   ...    │ │   ...    │           │    │
│  │  └──────────┘ └──────────┘ └──────────┘           │    │
│  └────────────────────────────────────────────────────┘    │
│                                                               │
│  ┌────────────────────────────────────────────────────┐    │
│  │         Coins Table (币种详情表)                    │    │
│  │                                                      │    │
│  │  ┌────┬────┬────┬────┬────┬────┬────┬────┬────┐  │    │
│  │  │币种│ 3m │ 1h │ 3h │ 6h │12h │24h │ ...│    │  │    │
│  │  ├────┼────┼────┼────┼────┼────┼────┼────┼────┤  │    │
│  │  │BTC │做多│做多│做多│做多│做多│做多│    │    │  │    │
│  │  │    │做空│做空│做空│做空│做空│做空│    │    │  │    │
│  │  │    │差值│差值│差值│差值│差值│差值│    │    │  │    │
│  │  ├────┼────┼────┼────┼────┼────┼────┼────┼────┤  │    │
│  │  │ETH │ ...│ ...│ ...│ ...│ ...│ ...│    │    │  │    │
│  │  ├────┼────┼────┼────┼────┼────┼────┼────┼────┤  │    │
│  │  │... │ ...│ ...│ ...│ ...│ ...│ ...│    │    │  │    │
│  │  └────┴────┴────┴────┴────┴────┴────┴────┴────┘  │    │
│  └────────────────────────────────────────────────────┘    │
│                                                               │
│  ┌────────────────────────────────────────────────────┐    │
│  │           JavaScript Logic                          │    │
│  │                                                      │    │
│  │  • loadStatistics() - 加载统计数据                 │    │
│  │  • loadCoins() - 加载币种数据                      │    │
│  │  • refreshData() - 刷新所有数据                    │    │
│  │  • Auto-refresh - 每3分钟自动刷新                  │    │
│  │                                                      │    │
│  │  • renderStatistics() - 渲染统计卡片               │    │
│  │  • renderCoinsTable() - 渲染币种表格               │    │
│  └────────────────────────────────────────────────────┘    │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 🎨 UI组件设计

### 统计卡片 (Stat Card)

```
┌─────────────────────────────┐
│      🕐 3分钟                │  ← 时间范围标签
├─────────────────────────────┤
│ 平均做多得分:      50.87    │  ← 做多得分
│ 平均做空得分:      51.37    │  ← 做空得分
├─────────────────────────────┤
│ 平均差值:      -0.50  📉   │  ← 差值 + 趋势图标
│ 币种数量:        19         │  ← 参与币种数
└─────────────────────────────┘

特性:
• 渐变色背景 (紫色系)
• 悬停时上浮动画
• 正差值显示绿色 📈
• 负差值显示红色 📉
```

### 币种表格 (Coins Table)

```
┌──────┬────────────┬────────────┬──────────┐
│ 币种  │   3分钟    │   1小时    │   ...    │
├──────┼───┬───┬───┼───┬───┬───┼──────────┤
│ BTC  │做多│做空│差 │做多│做空│差 │   ...    │
├──────┼───┼───┼───┼───┼───┼───┼──────────┤
│ ETH  │53 │56 │-3 │42 │46 │-4 │   ...    │
└──────┴───┴───┴───┴───┴───┴───┴──────────┘

特性:
• 做多得分: 绿色文本
• 做空得分: 红色文本
• 差值: 根据正负显示颜色
• 悬停行高亮
```

---

## 🔐 安全设计

### API安全
- CORS启用 (跨域资源共享)
- 无需认证 (内部系统)
- 只读API (除refresh外)

### 数据安全
- SQLite文件权限控制
- 输入数据验证
- SQL注入防护 (参数化查询)

### 服务安全
- 开发模式运行
- 局域网访问
- 无敏感数据暴露

---

## ⚡ 性能优化

### 数据库优化
```sql
-- 时间索引 (查询优化)
CREATE INDEX idx_score_history_time 
ON score_history(record_time DESC);

-- 币种索引 (过滤优化)
CREATE INDEX idx_score_history_symbol 
ON score_history(symbol, time_range);
```

### 查询优化
- 使用索引加速查询
- 限制返回数据量
- 缓存查询结果（未来）

### 前端优化
- 异步数据加载
- 按需渲染
- 定时刷新控制
- 响应式布局

---

## 📊 数据模型

### 得分记录 (ScoreRecord)
```python
{
    "symbol": "BTC-USDT-SWAP",        # 币种符号
    "time_range": "3m",               # 时间范围
    "long_score": 53.68,              # 做多得分 (0-100)
    "short_score": 56.03,             # 做空得分 (0-100)
    "score_diff": -2.35,              # 差值 (long - short)
    "data_source": "mock",            # 数据来源
    "record_time": "2025-12-03 15:19" # 记录时间
}
```

### 统计数据 (Statistics)
```python
{
    "time_range": "3m",               # 时间范围
    "avg_long_score": 50.87,          # 平均做多得分
    "avg_short_score": 51.37,         # 平均做空得分
    "avg_diff": -0.50,                # 平均差值
    "coin_count": 19,                 # 币种数量
    "trend": "📉 看空",               # 趋势方向
    "update_time": "2025-12-03 15:19" # 更新时间
}
```

---

## 🚀 部署架构

```
┌─────────────────────────────────────────┐
│         Sandbox Environment              │
│                                          │
│  ┌────────────────────────────────┐    │
│  │   Python Process (PID: 90112)  │    │
│  │                                 │    │
│  │   ┌─────────────────────────┐  │    │
│  │   │  Flask Web Server       │  │    │
│  │   │  Port: 5009             │  │    │
│  │   └─────────────────────────┘  │    │
│  │                                 │    │
│  │   ┌─────────────────────────┐  │    │
│  │   │  Auto Update Thread     │  │    │
│  │   │  Interval: 180s         │  │    │
│  │   └─────────────────────────┘  │    │
│  │                                 │    │
│  └────────────────────────────────┘    │
│                                          │
│  ┌────────────────────────────────┐    │
│  │   SQLite Database              │    │
│  │   crypto_data.db               │    │
│  │   Size: 668KB                  │    │
│  └────────────────────────────────┘    │
│                                          │
└──────────────┬───────────────────────────┘
               │
               │ HTTPS Tunnel
               │
┌──────────────▼───────────────────────────┐
│   Public Access (Sandbox URL)            │
│                                           │
│   https://5009-...-b32ec7bb.sandbox.     │
│         novita.ai                         │
│                                           │
│   📱 Web Browser                          │
│   🔧 API Clients                          │
│   🧪 Test Scripts                         │
└───────────────────────────────────────────┘
```

---

## 📝 技术栈总结

| 层级 | 技术 | 用途 |
|-----|------|-----|
| **前端** | HTML5 | 页面结构 |
| | CSS3 | 样式和布局 |
| | JavaScript | 交互逻辑 |
| **后端** | Python 3.12 | 核心编程语言 |
| | Flask | Web框架 |
| | Flask-CORS | 跨域支持 |
| **数据库** | SQLite 3 | 数据存储 |
| **并发** | threading | 多线程处理 |
| **工具** | curl | API测试 |
| | bash | 脚本自动化 |
| **版本控制** | Git | 代码管理 |
| | GitHub | 远程仓库 |

---

**文档版本**: V1.0  
**更新时间**: 2025-12-03  
**系统状态**: 🟢 运行中
